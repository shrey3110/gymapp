<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Savage Gym Tracker</title>

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#0a0a0a">
    <meta name="description" content="Track your gym progress with the bros, and roast them into gains.">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Savage Gym">
    
    <!-- PWA Manifest (Now linked to an external file) -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Apple Touch Icon (using a simple SVG fallback to avoid large base64) -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cpath fill='%23667eea' d='M256 64C150.13 64 128 86.13 128 192v96c0 105.87 22.13 128 128 128s128-22.13 128-128v-96c0-105.87-22.13-128-128-128z'%3E%3C/path%3E%3C/svg%3E">
    
    <!-- Google Fonts: Oswald (Heading), Inter (Body) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Oswald:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* General Theming & Visual Polish */
        :root {
            --dark-bg: #0a0a0a;
            --card-bg: #1a1a1a;
            --section-bg: #0f0f0f;
            --primary-color: #667eea; /* Blue-purple */
            --secondary-color: #4ade80; /* Green */
            --danger-color: #ef4444; /* Red */
            --warning-color: #fbbf24; /* Yellow */
            --text-light: #ffffff;
            --text-muted: #888;
            --gold: #ffd700;
            --silver: #c0c0c0;
            --bronze: #cd7f32;
            --neon-glow: 0 0 5px var(--primary-color), 0 0 10px var(--primary-color), 0 0 15px var(--primary-color);
            --danger-glow: 0 0 5px var(--danger-color), 0 0 10px var(--danger-color);
        }

        /* Dark grain noise background (CSS generated for compactness) */
        body {
            background-color: var(--dark-bg);
            background-image: linear-gradient(rgba(0, 0, 0, 0.1) 1px, transparent 1px),
                              linear-gradient(90deg, rgba(0, 0, 0, 0.1) 1px, transparent 1px);
            background-size: 2px 2px; /* Very small repeating pattern for subtle grain */
            font-family: 'Inter', sans-serif; /* Body font */
            min-height: 100vh;
            overflow-x: hidden;
            color: var(--text-light);
        }

        h1, h2, h3, h4 {
            font-family: 'Oswald', sans-serif; /* Heading font */
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }

        h1 {
            font-size: 2.8rem;
            text-shadow: var(--neon-glow);
        }
        h2 {
            font-size: 2.2rem;
            color: var(--text-light);
        }
        .section-title { /* For specific section titles with glow */
            background: linear-gradient(135deg, var(--primary-color) 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: var(--neon-glow);
        }

        /* Login Screen */
        .login-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: var(--dark-bg);
            padding: 20px;
            text-align: center;
            overflow: hidden;
            position: relative; /* For floating context */
        }

        .login-screen h1 {
            margin-bottom: 40px;
            z-index: 10; /* Keep title above floating cards */
            position: relative;
        }

        .user-list-container {
            position: absolute; /* Changed to absolute to allow floating */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            overflow: hidden;
        }

        .user-card {
            background: var(--card-bg);
            padding: 25px 35px; /* Increased padding */
            border-radius: 15px;
            border: 1px solid #333;
            cursor: pointer;
            transition: all 0.3s ease-in-out; /* Smooth transition */
            font-size: 1.2rem; /* Larger font */
            font-weight: 600;
            color: var(--text-light);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            min-width: 150px; /* Ensure cards are readable */
            text-align: center;
            position: absolute; /* Absolute for floating */
            will-change: transform; /* Optimize for animation */
            z-index: 5; /* Below title, above background */
            /* Initial random positions for better spread */
            left: calc(50% + var(--initial-x, 0px));
            top: calc(50% + var(--initial-y, 0px));
            transform: translate(-50%, -50%); /* Center the card itself */
        }

        /* Individual animation paths for more scattered floating */
        @keyframes float-1 { 0% { transform: translate(-50%, -50%) translate(0vw, 0vh) rotate(0deg); } 25% { transform: translate(-50%, -50%) translate(15vw, -20vh) rotate(5deg); } 50% { transform: translate(-50%, -50%) translate(-10vw, 15vh) rotate(-3deg); } 75% { transform: translate(-50%, -50%) translate(20vw, 5vh) rotate(7deg); } 100% { transform: translate(-50%, -50%) translate(0vw, 0vh) rotate(0deg); } }
        @keyframes float-2 { 0% { transform: translate(-50%, -50%) translate(0vw, 0vh) rotate(0deg); } 25% { transform: translate(-50%, -50%) translate(-10vw, 18vh) rotate(-2deg); } 50% { transform: translate(-50%, -50%) translate(18vw, -12vh) rotate(4deg); } 75% { transform: translate(-50%, -50%) translate(-5vw, -25vh) rotate(-6deg); } 100% { transform: translate(-50%, -50%) translate(0vw, 0vh) rotate(0deg); } }
        @keyframes float-3 { 0% { transform: translate(-50%, -50%) translate(0vw, 0vh) rotate(0deg); } 25% { transform: translate(-50%, -50%) translate(20vw, 10vh) scale(1.07) rotate(3deg); } 50% { transform: translate(-50%, -50%) translate(-15vw, -20vh) scale(0.92) rotate(-5deg); } 75% { transform: translate(-50%, -50%) translate(5vw, 25vh) scale(1.03) rotate(2deg); } 100% { transform: translate(-50%, -50%) translate(0vw, 0vh) rotate(0deg); } }
        @keyframes float-4 { 0% { transform: translate(-50%, -50%) translate(0vw, 0vh) rotate(0deg); } 25% { transform: translate(-50%, -50%) translate(-20vw, -10vh) scale(0.9) rotate(-7deg); } 50% { transform: translate(-50%, -50%) translate(10vw, 20vh) scale(1.1) rotate(8deg); } 75% { transform: translate(-50%, -50%) translate(-18vw, -5vh) scale(0.97) rotate(-2deg); } 100% { transform: translate(-50%, -50%) translate(0vw, 0vh) rotate(0deg); } }
        @keyframes float-5 { 0% { transform: translate(-50%, -50%) translate(0vw, 0vh) scale(1) rotate(0deg); } 25% { transform: translate(-50%, -50%) translate(8vw, 22vh) scale(1.03) rotate(1deg); } 50% { transform: translate(-50%, -50%) translate(-22vw, -8vh) scale(0.96) rotate(-4deg); } 75% { transform: translate(-50%, -50%) translate(15vw, -15vh) scale(1.09) rotate(6deg); } 100% { transform: translate(-50%, -50%) translate(0vw, 0vh) scale(1) rotate(0deg); } }
        @keyframes float-6 { 0% { transform: translate(-50%, -50%) translate(0vw, 0vh) scale(1) rotate(0deg); } 25% { transform: translate(-50%, -50%) translate(-15vw, -18vh) scale(0.92) rotate(-5deg); } 50% { transform: translate(-50%, -50%) translate(25vw, 10vh) scale(1.07) rotate(3deg); } 75% { transform: translate(-50%, -50%) translate(-8vw, 20vh) scale(0.99) rotate(-1deg); } 100% { transform: translate(-50%, -50%) translate(0vw, 0vh) scale(1) rotate(0deg); } }
        @keyframes float-7 { 0% { transform: translate(-50%, -50%) translate(0vw, 0vh) scale(1) rotate(0deg); } 25% { transform: translate(-50%, -50%) translate(12vw, 25vh) scale(1.06) rotate(4deg); } 50% { transform: translate(-50%, -50%) translate(-20vw, -10vh) scale(0.93) rotate(-6deg); } 75% { transform: translate(-50%, -50%) translate(5vw, -22vh) scale(1.04) rotate(2deg); } 100% { transform: translate(-50%, -50%) translate(0vw, 0vh) scale(1) rotate(0deg); } }
        @keyframes float-8 { 0% { transform: translate(-50%, -50%) translate(0vw, 0vh) scale(1) rotate(0deg); } 25% { transform: translate(-50%, -50%) translate(-25vw, 5vh) scale(0.91) rotate(-8deg); } 50% { transform: translate(-50%, -50%) translate(10vw, -20vh) scale(1.08) rotate(7deg); } 75% { transform: translate(-50%, -50%) translate(-12vw, 15vh) scale(0.96) rotate(-3deg); } 100% { transform: translate(-50%, -50%) translate(0vw, 0vh) scale(1) rotate(0deg); } }
        @keyframes float-9 { 0% { transform: translate(-50%, -50%) translate(0vw, 0vh) scale(1) rotate(0deg); } 25% { transform: translate(-50%, -50%) translate(18vw, -10vh) scale(1.02) rotate(2deg); } 50% { transform: translate(-50%, -50%) translate(-5vw, 22vh) scale(0.98) rotate(-4deg); } 75% { transform: translate(-50%, -50%) translate(22vw, 8vh) scale(1.05) rotate(5deg); } 100% { transform: translate(-50%, -50%) translate(0vw, 0vh) scale(1) rotate(0deg); } }


        .user-card:hover {
            transform: translateY(-10px) scale(1.05);
            border-color: var(--primary-color);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
            background: linear-gradient(135deg, var(--primary-color) 0%, #764ba2 100%);
            color: var(--text-light);
        }

        /* Main App Layout */
        .app {
            display: none;
            min-height: 100vh;
            background: var(--dark-bg);
        }

        /* Header */
        .app-header {
            background: var(--card-bg);
            padding: 15px 20px;
            border-bottom: 1px solid #333;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
        }

        .back-btn {
            background: #333;
            border: none;
            color: var(--text-light);
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
            display: none;
        }

        .back-btn:hover {
            background: #444;
        }

        /* My Profile Header Button */
        .my-profile-header-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 10px;
            transition: all 0.2s;
            flex-grow: 1; /* Allow it to take up space */
            justify-content: flex-start; /* Align content to start */
        }
        .my-profile-header-btn:hover {
            background: rgba(255,255,255,0.1);
            box-shadow: 0 0 5px var(--primary-color); /* Glow on hover */
        }
        .my-profile-header-btn.glowing-border {
            box-shadow: 0 0 8px var(--secondary-color), 0 0 15px var(--secondary-color); /* Stronger glow for streak */
        }

        .header-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            color: var(--primary-color);
        }
        .header-user-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-light);
        }

        /* Fellow Gym Bros Button (new styling) */
        .fellow-gym-bros-btn {
            background: var(--card-bg);
            color: var(--primary-color);
            border: 1px solid #333;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            flex-shrink: 0;
            min-width: 120px;
            text-align: center;
            margin-left: auto; /* Push to the right */
            margin-right: 10px; /* Space from other buttons */
            text-shadow: var(--neon-glow); /* Neon glow for button */
        }

        .fellow-gym-bros-btn:hover {
            background: #2a2a2a;
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
        }

        .header-action-btn {
            background: #333;
            color: var(--text-light);
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
            margin-left: 10px;
        }
        .header-action-btn:hover {
            background: #444;
        }


        /* Stats Bar (remains on main dashboard) */
        .stats-bar {
            background: var(--card-bg);
            padding: 20px;
            border-bottom: 1px solid #333;
        }

        .stats-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
        }

        .stat-item {
            text-align: center;
            flex: 1;
            min-width: 100px;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .stat-label {
            color: var(--text-muted);
            font-size: 0.9rem;
            text-transform: uppercase;
        }

        /* Main Content Grid */
        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
        }

        /* Main Section (Left Column) */
        .main-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Day Selection */
        .day-selection {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 20px;
        }

        .day-selection h2 {
            font-size: 2rem;
            margin-bottom: 30px;
            text-align: center;
            color: var(--text-light);
            text-shadow: var(--neon-glow);
        }

        .split-section {
            margin-bottom: 30px;
        }

        .split-title {
            color: var(--primary-color);
            font-size: 1.2rem;
            margin-bottom: 15px;
            text-align: center;
        }

        .day-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .day-btn {
            background: #2a2a2a;
            color: var(--text-light);
            border: 2px solid #333;
            padding: 20px 40px;
            border-radius: 15px; /* Pill shape */
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .day-btn:hover {
            background: #333;
            border-color: var(--primary-color);
            transform: scale(1.05);
            box-shadow: var(--neon-glow);
        }

        .day-btn.active {
            background: linear-gradient(135deg, var(--primary-color) 0%, #764ba2 100%);
            border-color: transparent;
            transform: scale(1.05);
            box-shadow: var(--neon-glow);
        }

        /* Workout Section */
        .workout-section {
            display: none;
            background: var(--card-bg);
            padding: 30px;
            border-radius: 20px;
        }

        .workout-section h2 {
            font-size: 2rem;
            margin-bottom: 30px;
            text-align: center;
            color: var(--primary-color);
            text-shadow: var(--neon-glow);
        }

        .exercise-card {
            background: var(--section-bg);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 1px solid #222;
            transition: all 0.3s;
        }

        .exercise-card:hover {
            border-color: var(--primary-color);
        }

        .exercise-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .exercise-name {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text-light);
            background: transparent;
            border: none;
            cursor: text;
            padding: 5px;
            border-radius: 5px;
            flex-grow: 1;
        }

        .set-row {
            display: grid;
            grid-template-columns: 60px 1fr 1fr 50px;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }

        .set-label {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .set-input {
            background: #222;
            border: 1px solid #333;
            color: var(--text-light);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            font-size: 0.95rem;
        }
        
        .add-set-btn, .remove-set-btn, .flag-set-btn {
            background: var(--primary-color);
            color: var(--text-light);
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
            width: fit-content;
        }
        .remove-set-btn { background: var(--danger-color); }
        .flag-set-btn { background: var(--warning-color); color: #333; } /* WTF SET button */

        .add-set-btn:hover { background: #5a67d8; box-shadow: var(--neon-glow); }
        .remove-set-btn:hover { background: #dc2626; box-shadow: var(--danger-glow); }
        .flag-set-btn:hover { background: #e0ac1a; box-shadow: 0 0 5px var(--warning-color); }

        .save-workout-btn {
            background: linear-gradient(135deg, var(--primary-color) 0%, #764ba2 100%);
            color: var(--text-light);
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            margin: 20px auto;
            display: block;
            box-shadow: var(--neon-glow);
        }

        /* Progress Chart within Exercise Card */
        .exercise-progress-chart {
            margin-top: 15px;
            height: 100px;
            background: var(--dark-bg);
            border-radius: 8px;
            padding: 5px;
            position: relative;
            overflow: hidden;
        }

        .chart-line {
            stroke: var(--primary-color);
            stroke-width: 2;
            fill: none;
        }
        .chart-points {
            fill: var(--primary-color);
            r: 3;
        }
        .chart-line.regression-up { stroke: var(--secondary-color); }
        .chart-line.regression-down { stroke: var(--danger-color); }
        .chart-line.regression-stable { stroke: var(--text-muted); }
        .chart-line.regression { stroke-dasharray: 4 2; }

        .chart-placeholder {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--text-muted);
            font-size: 0.8rem;
            text-align: center;
            width: 90%;
        }

        /* User Profile View (for others' profiles) */
        .user-profile-view {
            display: none;
            background: var(--card-bg);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 20px;
        }

        .profile-title {
            font-size: 2rem;
            margin-bottom: 20px;
            color: var(--primary-color);
            text-align: center;
            text-shadow: var(--neon-glow);
        }

        .previous-workout {
            background: var(--section-bg);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border: 1px solid #222;
        }

        .previous-date {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .previous-exercise {
            margin-bottom: 10px;
            font-size: 0.95rem;
        }

        .previous-exercise-name {
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 3px;
        }

        .previous-sets {
            color: #ccc;
            font-size: 0.85rem;
        }

        /* My Profile Section (new structure) */
        .my-profile-section {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            display: none; /* Hidden by default, shown by JS */
        }
        .my-profile-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 3rem;
            color: var(--primary-color);
            box-shadow: var(--neon-glow); /* Avatar glow */
        }
        .profile-info h3 {
            font-size: 1.8rem;
            color: var(--text-light);
            margin-bottom: 5px;
        }
        .profile-info p {
            color: var(--text-muted);
            font-size: 1rem;
        }
        .profile-rank {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--gold); /* Gold color for rank */
        }
        .profile-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .profile-stat-card {
            background: var(--section-bg);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #222;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .profile-stat-card .stat-number {
            font-size: 2.2rem;
            color: var(--secondary-color);
        }
        .profile-stat-card .stat-label {
            font-size: 0.85rem;
            color: var(--text-muted);
        }
        .profile-chart-container {
            margin-top: 30px;
            background: var(--section-bg);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid #222;
        }
        .profile-chart-container h4 {
            color: var(--text-light);
            margin-bottom: 15px;
            text-align: center;
        }
        .chart-placeholder-large {
            height: 200px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--text-muted);
            font-size: 1rem;
        }
        .pie-chart-svg {
            display: block;
            margin: 0 auto;
        }
        .pie-chart-legend {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            font-size: 0.9rem;
            color: #ccc;
        }
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
            margin-right: 5px;
        }
        .calendar-heatmap {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(15px, 1fr));
            gap: 2px;
            padding: 10px;
            background: var(--dark-bg);
            border-radius: 8px;
            margin-top: 20px;
        }
        .day-square {
            width: 15px;
            height: 15px;
            background-color: #222;
            border-radius: 3px;
        }
        .day-square.active-0 { background-color: #1a1a1a; } /* No workout */
        .day-square.active-1 { background-color: #2e7d32; } /* Dark Green - 1 workout */
        .day-square.active-2 { background-color: #43a047; } /* Medium Green - 2 workouts */
        .day-square.active-3 { background-color: #66bb6a; } /* Light Green - 3+ workouts */
        .day-square.skipped-roast { background-color: var(--danger-color); box-shadow: var(--danger-glow); } /* Blood red for skipped day */

        .month-label {
            grid-column: span 7; /* Span across a week */
            text-align: left;
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 5px;
            margin-bottom: 5px;
        }


        /* Stats & Leaderboard Page (New View) */
        .stats-leaderboard-page {
            display: none;
            background: var(--card-bg);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 20px;
        }

        .stats-leaderboard-page h2 {
            font-size: 2rem;
            margin-bottom: 30px;
            text-align: center;
            color: var(--primary-color);
            text-shadow: var(--neon-glow);
        }

        .stats-grid-detailed {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card-detailed {
            background: var(--section-bg);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid #222;
            text-align: center;
        }

        .stat-card-detailed .stat-number {
            font-size: 2.8rem;
            color: var(--secondary-color);
        }
        .stat-card-detailed .stat-label {
            font-size: 1rem;
            color: #ccc;
        }

        /* Sidebar (Right Column) */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .sidebar-section {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 15px;
        }

        .sidebar-title {
            font-size: 1.3rem;
            color: var(--primary-color);
            margin-bottom: 15px;
            text-align: center;
            text-transform: uppercase;
        }

        /* Leaderboard */
        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background: var(--section-bg);
            border-radius: 8px;
            transition: all 0.2s;
        }

        .leaderboard-item:hover {
            transform: translateX(5px);
            background: #222;
        }

        .leaderboard-rank {
            font-size: 1.2rem;
            width: 30px;
            text-align: center;
            color: var(--text-muted);
        }

        .leaderboard-name {
            flex-grow: 1;
            margin-left: 10px;
            color: var(--text-light);
        }

        .leaderboard-value {
            font-weight: 600;
            color: var(--primary-color);
        }

        /* Top 3 Leaderboard Styling */
        .leaderboard-item.top-1 {
            background: linear-gradient(135deg, var(--gold) 0%, #ffc107 100%);
            color: #1a1a1a;
            font-size: 1.1rem;
            padding: 12px;
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
            position: relative;
            z-index: 2;
        }
        .leaderboard-item.top-1 .leaderboard-name,
        .leaderboard-item.top-1 .leaderboard-value {
            color: #1a1a1a;
        }
        .leaderboard-item.top-1 .leaderboard-rank {
            color: #8B4513; /* Darker brown for contrast */
        }

        .leaderboard-item.top-2 {
            background: linear-gradient(135deg, var(--silver) 0%, #a8a8a8 100%);
            color: #1a1a1a;
            font-size: 1.05rem;
            padding: 11px;
            transform: scale(1.02);
            box-shadow: 0 3px 10px rgba(192, 192, 192, 0.3);
            position: relative;
            z-index: 1;
        }
        .leaderboard-item.top-2 .leaderboard-name,
        .leaderboard-item.top-2 .leaderboard-value {
            color: #1a1a1a;
        }
        .leaderboard-item.top-2 .leaderboard-rank {
            color: #4b5563; /* Darker grey for contrast */
        }

        .leaderboard-item.top-3 {
            background: linear-gradient(135deg, var(--bronze) 0%, #b86b25 100%);
            color: #1a1a1a;
            font-size: 1rem;
            padding: 10px;
            transform: scale(1.01);
            box-shadow: 0 2px 8px rgba(205, 127, 50, 0.3);
            position: relative;
            z-index: 0;
        }
        .leaderboard-item.top-3 .leaderboard-name,
        .leaderboard-item.top-3 .leaderboard-value {
            color: #1a1a1a;
        }
        .leaderboard-item.top-3 .leaderboard-rank {
            color: #3f1d00; /* Even darker brown for contrast */
        }
        
        .show-all-btn {
            display: block;
            width: 100%;
            background: #2a2a2a;
            color: var(--primary-color);
            border: 1px solid #333;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            margin-top: 10px;
            transition: background 0.2s, border-color 0.2s;
        }
        .show-all-btn:hover {
            background: #333;
            border-color: var(--primary-color);
        }

        /* Roast Messages */
        .roast-message {
            color: var(--danger-color);
            font-style: italic;
            font-weight: 600;
            font-size: 0.9em;
        }
        .ghost-badge {
            display: inline-block;
            background: #333;
            color: var(--text-muted);
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 0.8rem;
            margin-left: 5px;
        }

        /* PWA Install Button */
        .install-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, var(--primary-color) 0%, #764ba2 100%);
            color: var(--text-light);
            border: none;
            padding: 15px 25px;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: all 0.3s;
            z-index: 1000;
        }

        .install-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        /* Admin Panel */
        .admin-panel {
            display: none;
            background: var(--card-bg);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            border: 2px solid var(--primary-color);
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }

        .admin-title {
            font-size: 1.8rem;
            color: var(--primary-color);
            margin-bottom: 20px;
            text-align: center;
        }

        .admin-section {
            background: var(--section-bg);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 1px solid #222;
        }

        .admin-section h3 {
            color: var(--text-light);
            margin-bottom: 15px;
        }

        .admin-btn {
            background: var(--primary-color);
            color: var(--text-light);
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1.2rem;
            margin-left: 15px;
        }

        .admin-btn:hover {
            background: #5a67d8;
            transform: scale(1.05);
        }

        .admin-input, .admin-select {
            background: #222;
            border: 1px solid #333;
            color: var(--text-light);
            padding: 10px;
            border-radius: 8px;
            margin-right: 10px;
            width: 200px;
        }

        .admin-action-btn {
            background: var(--primary-color);
            color: var(--text-light);
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            margin: 5px;
        }

        .admin-action-btn:hover {
            background: #5a67d8;
        }

        .admin-danger-btn {
            background: var(--danger-color);
            color: var(--text-light);
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            margin: 5px;
        }

        .admin-danger-btn:hover {
            background: #dc2626;
        }

        .admin-info {
            color: var(--text-muted);
            margin-top: 10px;
        }

        .user-item, .exercise-item, .roast-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: var(--card-bg);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .remove-btn {
            background: var(--danger-color);
            color: var(--text-light);
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .remove-btn:hover {
            background: #dc2626;
        }

        .help-section {
            background: #222;
            padding: 15px;
            border-radius: 10px;
            margin-top: 10px;
        }

        .help-section summary {
            cursor: pointer;
            color: var(--primary-color);
            font-weight: 600;
        }

        .help-content {
            margin-top: 15px;
            color: #ccc;
            line-height: 1.6;
        }

        .help-content h4 {
            color: var(--primary-color);
            margin: 15px 0 10px 0;
        }

        .help-content ul {
            margin-left: 20px;
        }

        .help-content li {
            margin-bottom: 5px;
        }

        /* Community Section */
        .community-section {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
        }

        .community-title {
            font-size: 1.8rem;
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        .user-summary {
            background: var(--section-bg);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 15px;
            border: 1px solid #222;
            cursor: pointer;
            transition: all 0.2s;
        }
        .user-summary:hover {
            border-color: var(--primary-color);
            transform: translateY(-3px);
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.2);
        }

        .user-summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .user-summary-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-light);
        }

        .user-streak {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #ff6b6b;
        }

        .workout-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .breakdown-item {
            text-align: center;
            padding: 10px;
            background: var(--card-bg);
            border-radius: 8px;
        }

        .breakdown-number {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .breakdown-label {
            font-size: 0.7rem;
            color: var(--text-muted);
        }


        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                order: -1;
            }
        }

        @media (max-width: 768px) {
            .stats-container {
                flex-direction: column;
                gap: 15px;
            }
            
            .day-buttons {
                flex-direction: column;
            }
            
            .day-btn {
                width: 100%;
            }

            .set-row {
                grid-template-columns: 1fr 1fr;
            }
            .set-label {
                grid-column: 1 / -1;
            }
        }
        
        /* Modal Styles */
        .app-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000; /* High z-index to be on top */
            animation: fadeIn 0.3s ease-out;
        }

        .app-modal-content {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 350px;
            width: 90%;
            color: var(--text-light);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            animation: slideIn 0.3s ease-out;
        }

        .app-modal-content p {
            margin-bottom: 20px;
            font-size: 1.1rem;
            line-height: 1.5;
        }

        .app-modal-content button {
            background: var(--primary-color);
            color: var(--text-light);
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            margin: 0 5px;
        }

        .app-modal-content button.danger {
            background: var(--danger-color);
        }

        .app-modal-content button:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Confetti Effect (simple dots) */
        .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 9999;
        }
        .confetti-dot {
            position: absolute;
            width: 8px;
            height: 8px;
            background-color: var(--primary-color);
            border-radius: 50%;
            opacity: 0;
            animation: confetti-fall 3s forwards;
        }
        .confetti-dot:nth-child(even) { background-color: var(--secondary-color); }
        .confetti-dot:nth-child(odd) { background-color: var(--warning-color); }

        @keyframes confetti-fall {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <h1>SAVAGE GYM TRACKER</h1>
        <div class="user-list-container" id="userListContainer">
            <!-- User cards will be dynamically loaded here -->
        </div>
    </div>

    <!-- Main App -->
    <div class="app" id="app" style="display: none;">
        <!-- Header -->
        <div class="app-header">
            <div class="header-content">
                <button class="back-btn" id="appBackButton" onclick="goBack()">‚¨Ö BACK</button>
                <button class="my-profile-header-btn" onclick="showView('myProfileSection')">
                    <div class="header-avatar">üë§</div>
                    <div class="header-user-name" id="userDisplay"></div>
                </button>
                <!-- New "Fellow Gym Bros" button -->
                <button class="fellow-gym-bros-btn" onclick="showView('statsLeaderboardPage')">Fellow Gym Bros</button>
                <button class="header-action-btn" id="adminBtn" onclick="toggleAdminPanel()" style="display: none;">‚öôÔ∏è Admin</button>
                <button class="header-action-btn" onclick="logout()">Switch User</button>
            </div>
        </div>

        <!-- Stats Bar (remains on main dashboard for quick overview) -->
        <div class="stats-bar">
            <div class="stats-container">
                <div class="stat-item">
                    <div class="stat-number" id="streakCount">0</div>
                    <div class="stat-label">Streak üî•</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="totalDays">0</div>
                    <div class="stat-label">Total Workouts</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="proteinStreak">0</div>
                    <div class="stat-label">Protein Streak üç≥</div>
                </div>
            </div>
        </div>

        <!-- Main Content (contains Day Selection, Workout Section, User Profile, Stats/Leaderboard Page, Community) -->
        <div class="main-content">
            <div class="main-section">
                <!-- Day Selection (Default landing page) -->
                <div class="day-selection" id="daySelection">
                    <h2 class="section-title">WHAT ARE WE HITTING TODAY</h2>
                    
                    <!-- 4 Day Split -->
                    <div class="split-section">
                        <div class="split-title">4 DAY SPLIT</div>
                        <div class="day-buttons">
                            <button class="day-btn" onclick="selectDay('chest')">CHEST</button>
                            <button class="day-btn" onclick="selectDay('back')">BACK</button>
                            <button class="day-btn" onclick="selectDay('arms')">ARMS</button>
                            <button class="day-btn" onclick="selectDay('legs')">LEGS</button>
                        </div>
                    </div>

                    <!-- PPL 3 Day Split -->
                    <div class="split-section">
                        <div class="split-title">PPL - 3 DAY SPLIT</div>
                        <div class="day-buttons">
                            <button class="day-btn" onclick="selectDay('push')">PUSH</button>
                            <button class="day-btn" onclick="selectDay('pull')">PULL</button>
                            <button class="day-btn" onclick="selectDay('legs')">LEGS</button>
                        </div>
                    </div>
                </div>

                <!-- Workout Section (hidden by default, shown when day selected) -->
                <div class="workout-section" id="workoutSection">
                    <h2 id="workoutTitle" class="section-title"></h2>
                    <div id="exercisesContainer"></div>
                    <label class="protein-checkbox" style="display:flex; align-items:center; justify-content:center; gap: 10px; font-size: 1.1rem; cursor: pointer; margin: 20px 0;">
                        <input type="checkbox" id="workoutProteinCheck" onchange="saveProteinStatus()">
                        <span>Did you have 80g+ protein today? üí™</span>
                    </label>
                    <button class="save-workout-btn" onclick="saveWorkout()">SAVE WORKOUT</button>
                </div>

                <!-- My Profile Section (New) -->
                <div class="my-profile-section" id="myProfileSection">
                    <h2 class="section-title">MY PROFILE</h2>
                    <div class="my-profile-header">
                        <div class="profile-avatar">üë§</div>
                        <div class="profile-info">
                            <h3 id="myProfileName"></h3>
                            <p class="profile-rank" id="myProfileRank"></p>
                        </div>
                    </div>
                    <div class="profile-stats-grid">
                        <div class="profile-stat-card">
                            <div class="stat-number" id="myProfileCurrentStreak">0</div>
                            <div class="stat-label">Current Streak üî•</div>
                        </div>
                        <div class="profile-stat-card">
                            <div class="stat-number" id="myProfileTotalWorkouts">0</div>
                            <div class="stat-label">Total Workouts</div>
                        </div>
                        <div class="profile-stat-card">
                            <div class="stat-number" id="myProfileChestDays">0</div>
                            <div class="stat-label">Chest Days</div>
                        </div>
                        <div class="profile-stat-card">
                            <div class="stat-number" id="myProfileBackDays">0</div>
                            <div class="stat-label">Back Days</div>
                        </div>
                        <div class="profile-stat-card">
                            <div class="stat-number" id="myProfileArmDays">0</div>
                            <div class="stat-label">Arm Days</div>
                        </div>
                        <div class="profile-stat-card">
                            <div class="stat-number" id="myProfileLegDays">0</div>
                            <div class="stat-label">Leg Days</div>
                        </div>
                    </div>

                    <div class="profile-chart-container">
                        <h4>Workout Distribution</h4>
                        <div id="workoutDistributionChart" class="chart-placeholder-large">Loading Chart...</div>
                        <div class="pie-chart-legend" id="workoutDistributionLegend"></div>
                    </div>

                    <div class="profile-chart-container">
                        <h4>Workout Heatmap</h4>
                        <div id="workoutHeatmap" class="calendar-heatmap"></div>
                    </div>

                    <div class="profile-chart-container">
                        <h4>Savage Tools</h4>
                        <button class="show-all-btn" onclick="triggerPRSelfie()">Flex now or it didn't happen. üì∏</button>
                        <button class="show-all-btn" onclick="roastMyWeakness()">Roast My Weakness. üòà</button>
                        <button class="show-all-btn" onclick="generateExcuse()">I Need an Excuse. üò¥</button>
                        <button class="show-all-btn" onclick="generateFakeStat()">Generate Fake Stat. üß¢</button>
                        <button class="show-all-btn" onclick="dailyDare()">Daily Dare. üéØ</button>
                        <button class="show-all-btn" onclick="showBroCode()">Bro Code. üìú</button>
                    </div>
                </div>

                <!-- Other User Profile View (hidden by default, shown when community member clicked) -->
                <div class="user-profile-view" id="userProfileView">
                    <h2 class="profile-title"></h2>
                    <div class="my-profile-header">
                        <div class="profile-avatar" style="background: #555;">üë•</div> <!-- Different avatar for others' profiles -->
                        <div class="profile-info">
                            <h3 id="otherProfileName"></h3>
                            <p class="profile-rank" id="otherProfileRank"></p>
                        </div>
                    </div>
                    <div class="profile-stats-grid">
                        <div class="profile-stat-card">
                            <div class="stat-number" id="otherProfileCurrentStreak">0</div>
                            <div class="stat-label">Current Streak üî•</div>
                        </div>
                        <div class="profile-stat-card">
                            <div class="stat-number" id="otherProfileTotalWorkouts">0</div>
                            <div class="stat-label">Total Workouts</div>
                        </div>
                        <div class="profile-stat-card">
                            <div class="stat-number" id="otherProfileChestDays">0</div>
                            <div class="stat-label">Chest Days</div>
                        </div>
                        <div class="profile-stat-card">
                            <div class="stat-number" id="otherProfileBackDays">0</div>
                            <div class="stat-label">Back Days</div>
                        </div>
                        <div class="profile-stat-card">
                            <div class="stat-number" id="otherProfileArmDays">0</div>
                            <div class="stat-label">Arm Days</div>
                        </div>
                        <div class="profile-stat-card">
                            <div class="stat-number" id="otherProfileLegDays">0</div>
                            <div class="stat-label">Leg Days</div>
                        </div>
                    </div>

                    <div class="profile-chart-container">
                        <h4>Workout Distribution</h4>
                        <div id="otherWorkoutDistributionChart" class="chart-placeholder-large">Loading Chart...</div>
                        <div class="pie-chart-legend" id="otherWorkoutDistributionLegend"></div>
                    </div>

                    <div class="profile-chart-container">
                        <h4>Workout Heatmap</h4>
                        <div id="otherWorkoutHeatmap" class="calendar-heatmap"></div>
                    </div>
                    <h3 style="color: var(--primary-color); text-align: center; margin-top: 30px; margin-bottom: 20px;">Workout History</h3>
                    <div id="otherUserProfileWorkouts"></div>
                </div>

                <!-- Stats & Leaderboard Page (New View - hidden by default) -->
                <div class="stats-leaderboard-page" id="statsLeaderboardPage">
                    <h2 class="section-title">ALL STATS & LEADERBOARDS</h2>
                    
                    <!-- Beast Mode Streaks -->
                    <div class="sidebar-section">
                        <h3 class="sidebar-title">üî• BEAST MODE STREAKS</h3>
                        <div id="fullStreakLeaderboard"></div>
                    </div>

                    <!-- Mr. Consistency -->
                    <div class="sidebar-section">
                        <h3 class="sidebar-title">üí™ MR. CONSISTENCY</h3>
                        <div id="fullConsistencyLeaderboard"></div>
                    </div>

                    <!-- Excusers Club -->
                    <div class="sidebar-section">
                        <h3 class="sidebar-title">üò§ THE EXCUSERS CLUB</h3>
                        <div id="fullExcusersLeaderboard"></div>
                    </div>

                    <!-- Chicken Legs -->
                    <div class="sidebar-section">
                        <h3 class="sidebar-title">ü¶µ CHICKEN LEGS WATCHLIST</h3>
                        <div id="fullChickenLegsLeaderboard"></div>
                    </div>
                </div>

                <!-- Community Section (default view for daily highlights) -->
                <div class="community-section" id="communitySection">
                    <h2 class="section-title">Community Progress üèãÔ∏è</h2>
                    <div id="communityContainer"></div>
                </div>
            </div>

            <!-- Sidebar (Daily Highlights & Protein tracking) -->
            <div class="sidebar">
                <!-- My Profile Button (moved here) -->
                <button class="show-all-btn" onclick="showView('myProfileSection')" style="margin-bottom: 20px;">My Profile</button>

                <!-- Daily Highlights -->
                <div class="sidebar-section">
                    <h3 class="sidebar-title">Today's Warriors üí™</h3>
                    <div id="dailyHighlightsContainer"></div>
                </div>

                <!-- Protein Tracking Section -->
                <div class="sidebar-section">
                    <h3 class="sidebar-title">ü•© Daily Protein Target</h3>
                    <label class="protein-checkbox" style="display:flex; align-items:center; justify-content:center; gap: 10px; font-size: 1.1rem; cursor: pointer; margin: 10px 0;">
                        <input type="checkbox" id="proteinCheck" onchange="saveProteinStatus()">
                        <span>80g+ Protein Today</span>
                    </label>
                    <div class="protein-stats" id="proteinStats" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                         <!-- Protein stats will be loaded here -->
                    </div>
                    <button class="show-all-btn" onclick="toggleProteinShoutouts()">Show Community Protein Updates</button>
                    <div class="protein-shoutouts" id="proteinShoutouts" style="background: #0a0a0a; padding: 15px; border-radius: 10px; margin-top: 15px; display: none;">
                        <h4 style="color: var(--secondary-color); margin-bottom: 10px; text-align: center;">Community Protein Updates</h4>
                        <!-- Shoutouts will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- PWA Install Button -->
    <button class="install-btn" id="installBtn" style="display: none;">
        üì± Install App
    </button>

    <script>
        // Exercise templates
        // This will now be the DEFAULT template for new users.
        // Each user will have their own copy stored in localStorage.
        const defaultExerciseTemplates = {
            chest: ['Chest Overhead Press', 'Cable Chest Fly', 'Shoulder Overhead Press', 'Machine Chest Press', 'Dumbbell Lateral Raise', ''],
            back: ['Pull-up', 'Lat Pulldown', 'Seated Cable Row', 'T-Bar Row (Substitute)', 'Face Pull', ''],
            arms: ['Triceps Overhead Press', 'Triceps Pushdown', 'Hammer Curl', 'Preacher Curl', 'Barbell Curl', ''],
            legs: ['Squat', 'Hamstring Curl', 'Leg Extension (Quad)', 'Calf Raise', 'Leg Press', ''],
            push: ['Chest Overhead Press', 'Cable Chest Fly', 'Shoulder Overhead Press', 'Machine Chest Press', 'Dumbbell Lateral Raise', 'Triceps Overhead Press', 'Triceps Pushdown', ''],
            pull: ['Pull-up', 'Lat Pulldown', 'Seated Cable Row', 'T-Bar Row (Substitute)', 'Face Pull', 'Hammer Curl', 'Preacher Curl', '']
        };

        // Brutal roast messages
        let roastMessages = [
            "is a pathetic weakling who's allergic to gains ü§°",
            "probably cried looking at the weights today üò≠",
            "thinks protein shakes are meal replacements ü§¶‚Äç‚ôÇÔ∏è",
            "is building that dad bod at 20 ÔøΩ",
            "has the testosterone levels of a newborn üë∂",
            "makes excuses like it's cardio üèÉ‚Äç‚ôÇÔ∏è",
            "is cultivating mass... of fat üê∑",
            "has invisible lat syndrome ü¶Ö",
            "benches the bar and calls it heavy üèãÔ∏è‚Äç‚ôÇÔ∏è",
            "skips leg day since birth ü¶©",
            "has noodle arms and claims genetics üçú",
            "thinks walking to the fridge is cardio üö∂‚Äç‚ôÇÔ∏è",
            "is too busy being a princess üëë to hit the gym",
            "found a new Netflix series, gym can wait üò¥",
            "might need a wheelchair after skipping so many leg days ‚ôø"
        ];

        // Dumb AF additions for savage mode
        const wtfSetRoasts = [
            "Bro what even was that set üíÄ",
            "Form worse than your CGPA.",
            "3kg dumbbells? For warmup or ego lifting?",
            "Did you even lift, bro? Or just wave your arms?",
            "That set was so bad, my gains went into hiding.",
            "Are you trying to impress a snail with that speed?",
            "I've seen stronger toddlers.",
            "That's not lifting, that's interpretive dance."
        ];

        const fakeStats = [
            "Aaryan benched 150kg today",
            "Aadi PR‚Äôd on cardio. Walked to class for once.",
            "Akhil deadlifted a small car. Or maybe it was a toy car.",
            "Jay ran a marathon... on his gaming chair.",
            "Rushil Bhai just gained 10kg of pure muscle. Overnight.",
            "Sarthak's biceps grew 2 inches just by looking at a dumbbell.",
            "Vishal invented a new exercise: The 'couch potato curl'."
        ];

        const excuses = [
            "Was busy... dying inside.",
            "My cat needed emotional support.",
            "The gym weights looked too intimidating today.",
            "I had a sudden allergic reaction to motivation.",
            "My gains were already too big, needed a rest day from progress.",
            "I accidentally signed up for a knitting class instead.",
            "The universe told me to rest. Who am I to argue?"
        ];

        const broCode = [
            "Thou shalt not curl in the squat rack.",
            "Thou shalt spot thy bro, even if he's clearly failing.",
            "Thou shalt not skip leg day, for chicken legs are a sin.",
            "Thou shalt consume thy protein, or face eternal shame.",
            "Thou shalt not make eye contact during deadlifts.",
            "Thou shalt always re-rack thy weights, unless you're a savage.",
            "Thou shalt never admit weakness, only 'strategic deloads'."
        ];

        // User list (Shreyash is now the admin)
        let userList = ['Shreyash', 'Aadi', 'Aaryan', 'Akhil', 'Akshal', 'Jay', 'Rushil Bhai', 'Sarthak', 'Vishal'];
        
        let currentUser = null;
        let selectedDay = null;
        let currentWorkout = [];
        let deferredPrompt = null;
        let currentView = 'daySelection'; // Tracks current active view

        // User-specific exercise templates
        let userExerciseTemplates = {}; 

        // Initialize app
        function init() {
            loadSavedData();
            
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser && userList.includes(savedUser)) {
                currentUser = savedUser;
                showApp();
            } else {
                renderUserSelection(); // Render floating user cards
                document.getElementById('loginScreen').style.display = 'flex';
            }
            
            // PWA install prompt
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                document.getElementById('installBtn').style.display = 'block';
            });

            // Register service worker
            if ('serviceWorker' in navigator) {
                // Point to service-worker.js in the same directory
                navigator.serviceWorker.register('service-worker.js').catch(err => console.log('SW registration failed:', err));
            }
        }

        // Load saved data (user list, exercises, roasts)
        function loadSavedData() {
            const savedUsers = localStorage.getItem('userList');
            if (savedUsers) {
                userList = JSON.parse(savedUsers);
            }
            
            // Load user-specific exercise templates
            userList.forEach(user => {
                const savedUserExercises = localStorage.getItem(`exerciseTemplates_${user}`);
                if (savedUserExercises) {
                    userExerciseTemplates[user] = JSON.parse(savedUserExercises);
                } else {
                    // If no user-specific template, initialize from default
                    userExerciseTemplates[user] = JSON.parse(JSON.stringify(defaultExerciseTemplates)); // Deep copy
                    localStorage.setItem(`exerciseTemplates_${user}`, JSON.stringify(userExerciseTemplates[user]));
                }
            });
            
            const savedRoasts = localStorage.getItem('roastMessages');
            if (savedRoasts) {
                roastMessages = JSON.parse(savedRoasts);
            }
        }

        // Render user selection cards on login screen
        function renderUserSelection() {
            const container = document.getElementById('userListContainer');
            container.innerHTML = '';
            userList.sort().forEach((user, index) => {
                const userCard = document.createElement('div');
                userCard.className = 'user-card';
                userCard.textContent = user;
                // Assign distinct animation names and initial positions
                userCard.style.animationName = `float-${(index % 9) + 1}`; // Cycle through float-1 to float-9
                // Distribute initial positions more widely
                userCard.style.setProperty('--initial-x', `${(Math.random() * 80 - 40)}vw`); // -40vw to +40vw
                userCard.style.setProperty('--initial-y', `${(Math.random() * 80 - 40)}vh`); // -40vh to +40vh
                userCard.onclick = () => login(user); // Pass user directly to login
                container.appendChild(userCard);
            });
        }

        // Install PWA
        document.getElementById('installBtn').addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    deferredPrompt = null;
                    document.getElementById('installBtn').style.display = 'none';
                }
            }
        });

        // Login function (now takes username directly from card click)
        function login(username) {
            if (username) {
                currentUser = username;
                localStorage.setItem('currentUser', username);
                showApp();
            } else {
                showModal('Please select your name to start tracking.', 'OK');
            }
        }

        // Show main app
        function showApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            
            // Update header profile button
            const headerUserName = document.getElementById('userDisplay');
            if(headerUserName) headerUserName.textContent = currentUser;

            // Show admin button only for Shreyash
            if (currentUser === 'Shreyash') {
                document.getElementById('adminBtn').style.display = 'inline-block'; 
            } else {
                document.getElementById('adminBtn').style.display = 'none';
            }

            // Always start on the main day selection view
            showView('daySelection');
            loadStats();
            loadLeaderboards();
            loadDailyHighlights();
            loadProteinData();
            loadCommunity();
            loadMyProfile(); // Load data for the new My Profile section
        }

        // Manages which "page" or section is visible
        function showView(viewId) {
            // Hide all main sections by getting them once and checking for existence
            const sections = [
                document.getElementById('daySelection'),
                document.getElementById('workoutSection'),
                document.getElementById('userProfileView'),
                document.getElementById('communitySection'),
                document.getElementById('adminPanel'),
                document.getElementById('statsLeaderboardPage'),
                document.getElementById('myProfileSection')
            ];

            sections.forEach(section => {
                if (section) {
                    section.style.display = 'none';
                }
            });

            // Show the requested section
            const targetSection = document.getElementById(viewId);
            if (targetSection) {
                targetSection.style.display = 'block';
            }
            currentView = viewId;

            // Adjust back button visibility/action based on view
            const backBtn = document.getElementById('appBackButton');
            if (backBtn) {
                // Back button hidden on main landing pages (Day Selection, My Profile, Community)
                if (viewId === 'daySelection' || viewId === 'myProfileSection' || viewId === 'communitySection') {
                    backBtn.style.display = 'none'; 
                } else {
                    backBtn.style.display = 'inline-block';
                }
            }
        }

        // Go back function
        function goBack() {
            if (currentView === 'workoutSection') {
                showView('daySelection');
            } else if (currentView === 'userProfileView') {
                showView('communitySection');
            } else if (currentView === 'adminPanel' || currentView === 'statsLeaderboardPage') {
                showView('myProfileSection');
            } else {
                showView('daySelection'); // Fallback
            }
            loadStats();
            loadLeaderboards();
            loadDailyHighlights();
            loadProteinData();
            loadCommunity();
            loadMyProfile();
        }

        // Toggle admin panel
        function toggleAdminPanel() {
            if (currentView === 'adminPanel') {
                showView('daySelection');
            } else {
                showView('adminPanel');
                loadAdminData();
            }
        }

        // Load admin data
        function loadAdminData() {
            const usersDiv = document.getElementById('adminUsers');
            if (usersDiv) {
                usersDiv.innerHTML = '';
                userList.forEach(user => {
                    const userItem = document.createElement('div');
                    userItem.className = 'user-item';
                    userItem.innerHTML = `
                        <span>${user}</span>
                        <button class="remove-btn" onclick="removeUser('${user}')">‚ùå</button>
                    `;
                    usersDiv.appendChild(userItem);
                });
            }
            const totalUsersSpan = document.getElementById('totalUsers');
            if (totalUsersSpan) {
                totalUsersSpan.textContent = userList.length;
            }
            
            const roastDiv = document.getElementById('roastEditor'); // Corrected ID
            if (roastDiv) {
                roastDiv.innerHTML = '';
                roastMessages.forEach((roast, index) => {
                    const roastItem = document.createElement('div');
                    roastItem.className = 'roast-item';
                    roastItem.innerHTML = `
                        <input type="text" value="${roast}" onchange="updateRoast(${index}, this.value)" 
                               style="flex: 1; background: #222; border: 1px solid #333; color: #fff; padding: 5px; border-radius: 5px;">
                        <button class="remove-btn" onclick="removeRoast(${index})">‚ùå</button>
                    `;
                    roastDiv.appendChild(roastItem);
                });
                const addRoastBtn = document.createElement('button');
                addRoastBtn.className = 'admin-action-btn';
                addRoastBtn.textContent = '‚ûï Add Roast';
                addRoastBtn.onclick = addRoast;
                roastDiv.appendChild(addRoastBtn);
            }
        }

        // Admin functions
        function addUser() {
            const input = document.getElementById('newUserInput');
            const newUser = input.value.trim();
            if (newUser && !userList.includes(newUser)) {
                userList.push(newUser);
                userList.sort();
                localStorage.setItem('userList', JSON.stringify(userList));
                
                userExerciseTemplates[newUser] = JSON.parse(JSON.stringify(defaultExerciseTemplates));
                localStorage.setItem(`exerciseTemplates_${newUser}`, JSON.stringify(userExerciseTemplates[newUser]));

                renderUserSelection();
                loadAdminData();
                input.value = '';
            }
        }

        function removeUser(user) {
            showConfirmModal(`Remove ${user} from the app? This will also delete their workout data.`, () => {
                userList = userList.filter(u => u !== user);
                localStorage.setItem('userList', JSON.stringify(userList));
                localStorage.removeItem(`workouts_${user}`);
                localStorage.removeItem(`protein_${user}`);
                localStorage.removeItem(`stats_${user}`);
                localStorage.removeItem(`exerciseTemplates_${user}`);

                renderUserSelection();
                loadAdminData();
                if (currentUser === user) {
                    logout();
                }
            });
        }

        function loadExercisesForEdit() {
            const day = document.getElementById('daySelect').value;
            if (!day) return;
            
            const editList = document.getElementById('exerciseEditList');
            if (!editList) return;

            editList.innerHTML = '';
            
            let exercisesToEdit = userExerciseTemplates[currentUser][day];

            if (!exercisesToEdit || exercisesToEdit.length === 0) {
                exercisesToEdit = [''];
            } else if (exercisesToEdit[exercisesToEdit.length - 1] !== '') {
                exercisesToEdit.push('');
            }
            userExerciseTemplates[currentUser][day] = exercisesToEdit;

            exercisesToEdit.forEach((exercise, index) => {
                const exerciseItem = document.createElement('div');
                exerciseItem.className = 'exercise-item';
                exerciseItem.innerHTML = `
                    <input type="text" value="${exercise}" onchange="updateExercise('${day}', ${index}, this.value)"
                           style="flex: 1; background: #222; border: 1px solid #333; color: #fff; padding: 5px; border-radius: 5px;">
                    ${index < exercisesToEdit.length - 1 ? `<button class="remove-btn" onclick="removeExercise('${day}', ${index})">‚ùå</button>` : ''}
                `;
                editList.appendChild(exerciseItem);
            });
            
            if (exercisesToEdit[exercisesToEdit.length - 1] !== '') {
                const addBtn = document.createElement('button');
                addBtn.className = 'admin-action-btn';
                addBtn.textContent = '‚ûï Add Exercise';
                addBtn.onclick = () => addExercise(day);
                editList.appendChild(addBtn);
            }
            localStorage.setItem(`exerciseTemplates_${currentUser}`, JSON.stringify(userExerciseTemplates[currentUser]));
        }

        function updateExercise(day, index, value) {
            userExerciseTemplates[currentUser][day][index] = value;
            localStorage.setItem(`exerciseTemplates_${currentUser}`, JSON.stringify(userExerciseTemplates[currentUser]));
            loadExercisesForEdit();
        }

        function removeExercise(day, index) {
            userExerciseTemplates[currentUser][day].splice(index, 1);
            localStorage.setItem(`exerciseTemplates_${currentUser}`, JSON.stringify(userExerciseTemplates[currentUser]));
            loadExercisesForEdit();
        }

        function addExercise(day) {
            if (userExerciseTemplates[currentUser][day][userExerciseTemplates[currentUser][day].length - 1] === '') {
                return;
            }
            userExerciseTemplates[currentUser][day].push('');
            localStorage.setItem(`exerciseTemplates_${currentUser}`, JSON.stringify(userExerciseTemplates[currentUser]));
            loadExercisesForEdit();
            const newInputs = document.querySelectorAll('#exerciseEditList input[type="text"]');
            if (newInputs.length > 0) {
                newInputs[newInputs.length - 1].focus();
            }
        }

        function updateRoast(index, value) {
            roastMessages[index] = value;
        }

        function removeRoast(index) {
            roastMessages.splice(index, 1);
            loadAdminData();
        }

        function addRoast() {
            roastMessages.push("New brutal roast message!");
            loadAdminData();
            const newInputs = document.querySelectorAll('#roastEditor input[type="text"]');
            if (newInputs.length > 0) {
                newInputs[newInputs.length - 1].focus();
            }
        }

        function saveRoasts() {
            localStorage.setItem('roastMessages', JSON.stringify(roastMessages));
            showModal('Roast messages saved! üí™', 'OK');
        }

        // Data management
        function exportData() {
            const allData = {
                userList,
                defaultExerciseTemplates,
                roastMessages,
                workouts: {},
                proteinData: {},
                userExerciseTemplates: {}
            };
            
            userList.forEach(user => {
                const userKey = `workouts_${user}`;
                const workouts = localStorage.getItem(userKey);
                if (workouts) {
                    allData.workouts[user] = JSON.parse(workouts);
                }
                
                const proteinKey = `protein_${user}`;
                const protein = localStorage.getItem(proteinKey);
                if (protein) {
                    allData.proteinData[user] = JSON.parse(protein);
                }
                
                const userExTemplates = localStorage.getItem(`exerciseTemplates_${user}`);
                if (userExTemplates) {
                    allData.userExerciseTemplates[user] = JSON.parse(userExTemplates);
                }
            });
            
            const dataStr = JSON.stringify(allData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `savage-gym-tracker-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importData() {
            document.getElementById('importFile').click();
        }

        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    const importConfirm = (message) => { 
                        return new Promise(resolve => {
                            showConfirmModal(message, () => resolve(true), () => resolve(false), 'Yes', 'No');
                        });
                    };

                    const processImport = async () => {
                        if (data.userList && await importConfirm('Import user list? This will overwrite existing users.')) {
                            userList = data.userList;
                            localStorage.setItem('userList', JSON.stringify(userList));
                        }
                        
                        if (data.defaultExerciseTemplates && await importConfirm('Import default exercise templates? This will overwrite existing templates.')) {
                            Object.assign(defaultExerciseTemplates, data.defaultExerciseTemplates);
                        }
                        
                        if (data.roastMessages && await importConfirm('Import roast messages? This will overwrite existing roasts.')) {
                            roastMessages = data.roastMessages;
                            localStorage.setItem('roastMessages', JSON.stringify(roastMessages));
                        }
                        
                        if (data.workouts && await importConfirm('Import workout data? This will overwrite existing workout history for all users.')) {
                            Object.entries(data.workouts).forEach(([user, workouts]) => {
                                localStorage.setItem(`workouts_${user}`, JSON.stringify(workouts));
                            });
                        }
                        
                        if (data.proteinData && await importConfirm('Import protein data? This will overwrite existing protein logs for all users.')) {
                            Object.entries(data.proteinData).forEach(([user, protein]) => {
                                localStorage.setItem(`protein_${user}`, JSON.stringify(protein));
                            });
                        }

                        if (data.userExerciseTemplates && await importConfirm('Import user-specific exercise templates? This will overwrite existing templates.')) {
                            Object.entries(data.userExerciseTemplates).forEach(([user, templates]) => {
                                userExerciseTemplates[user] = templates;
                                localStorage.setItem(`exerciseTemplates_${user}`, JSON.stringify(templates));
                            });
                        }
                        
                        showModal('Data imported successfully! App will reload.', 'OK', () => location.reload());
                    };
                    processImport();

                } catch (err) {
                    showModal(`Error importing data: ${err.message}`, 'OK');
                }
            };
            reader.readAsText(file);
        }

        function resetAllData() {
            showConfirmModal('This will delete ALL data. Are you sure?', () => {
                showConfirmModal('This action cannot be undone. Continue?', () => {
                    localStorage.clear();
                    showModal('All data deleted. App will reload.', 'OK', () => location.reload());
                }, 'Yes, Delete All', 'Cancel');
            });
        }

        // Custom Modal Functions (replacing alert/confirm)
        function showModal(message, buttonText, callback = () => {}) {
            const modal = document.createElement('div');
            modal.className = 'app-modal';
            modal.innerHTML = `
                <div class="app-modal-content">
                    <p>${message}</p>
                    <button id="modalBtn">${buttonText}</button>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('modalBtn').onclick = () => {
                document.body.removeChild(modal);
                callback();
            };
        }

        function showConfirmModal(message, onConfirm, onCancel = () => {}, confirmText = 'Yes', cancelText = 'No') {
            const modal = document.createElement('div');
            modal.className = 'app-modal';
            modal.innerHTML = `
                <div class="app-modal-content">
                    <p>${message}</p>
                    <button id="modalConfirmYes">${confirmText}</button>
                    <button id="modalConfirmNo" class="danger">${cancelText}</button>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('modalConfirmYes').onclick = () => {
                document.body.removeChild(modal);
                onConfirm();
            };
            document.getElementById('modalConfirmNo').onclick = () => {
                document.body.removeChild(modal);
                onCancel();
            };
        }

        // Protein tracking
        function loadProteinData() {
            const today = new Date().toDateString();
            const proteinKey = `protein_${currentUser}`;
            const proteinData = JSON.parse(localStorage.getItem(proteinKey) || '{}');
            
            const proteinCheck = document.getElementById('proteinCheck');
            if (proteinCheck) {
                proteinCheck.checked = proteinData[today] || false;
            }
            const workoutProteinCheck = document.getElementById('workoutProteinCheck');
            if (workoutProteinCheck) {
                workoutProteinCheck.checked = proteinData[today] || false;
            }
            
            updateProteinStats();
        }

        function saveProteinStatus() {
            const today = new Date().toDateString();
            const proteinKey = `protein_${currentUser}`;
            const proteinData = JSON.parse(localStorage.getItem(proteinKey) || '{}');
            
            const proteinCheck = document.getElementById('proteinCheck');
            const isChecked = proteinCheck ? proteinCheck.checked : false;
            
            proteinData[today] = isChecked;
            
            localStorage.setItem(proteinKey, JSON.stringify(proteinData));
            
            const workoutProteinCheck = document.getElementById('workoutProteinCheck');
            if (workoutProteinCheck) {
                workoutProteinCheck.checked = isChecked;
            }
            
            updateProteinStats();
            loadStats(); 
            loadCommunity();

            // Confetti for protein hit
            if (isChecked) {
                spawnConfetti();
                // "Brah, don't lie" check
                const now = new Date();
                if (now.getHours() < 20 && !localStorage.getItem('proteinLieRoastShownToday')) { // Before 8 PM and not shown today
                    showModal("Brah, don‚Äôt lie. It's too early to claim that protein. üß¢", "Oops");
                    localStorage.setItem('proteinLieRoastShownToday', today.toDateString()); // Mark shown for today
                }
            }
        }

        function updateProteinStats() {
            const statsDiv = document.getElementById('proteinStats');
            if (!statsDiv) return;

            statsDiv.innerHTML = '';
            
            const proteinKey = `protein_${currentUser}`;
            const proteinData = JSON.parse(localStorage.getItem(proteinKey) || '{}');
            
            let currentStreak = 0;
            const today = new Date();
            today.setHours(0,0,0,0);
            
            for (let i = 0; i < 30; i++) {
                const checkDate = new Date(today);
                checkDate.setDate(checkDate.getDate() - i);
                if (proteinData[checkDate.toDateString()]) {
                    currentStreak++;
                } else if (i > 0) {
                    break;
                }
            }
            
            const totalProteinDays = Object.values(proteinData).filter(v => v).length;
            
            let last7Days = 0;
            for (let i = 0; i < 7; i++) {
                const checkDate = new Date();
                checkDate.setDate(checkDate.getDate() - i);
                if (proteinData[checkDate.toDateString()]) {
                    last7Days++;
                }
            }
            
            statsDiv.innerHTML = `
                <div class="protein-stat-card stat-item">
                    <div class="protein-stat-number stat-number">${currentStreak}</div>
                    <div class="protein-stat-label stat-label">Day Streak üî•</div>
                </div>
                <div class="protein-stat-card stat-item">
                    <div class="protein-stat-number stat-number">${totalProteinDays}</div>
                    <div class="protein-stat-label stat-label">Total Days</div>
                </div>
                <div class="protein-stat-card stat-item">
                    <div class="protein-stat-number stat-number">${last7Days}/7</div>
                    <div class="protein-stat-label stat-label">Last Week</div>
                </div>
            `;
            const proteinStreakElement = document.getElementById('proteinStreak');
            if (proteinStreakElement) {
                proteinStreakElement.textContent = currentStreak;
            }
        }

        // Toggles visibility of protein shoutouts
        function toggleProteinShoutouts() {
            const shoutoutsDiv = document.getElementById('proteinShoutouts');
            if (shoutoutsDiv) {
                if (shoutoutsDiv.style.display === 'none') {
                    shoutoutsDiv.style.display = 'block';
                    updateProteinShoutoutsContent();
                } else {
                    shoutoutsDiv.style.display = 'none';
                }
            }
        }

        // Renamed to avoid confusion with toggle, now just updates content
        function updateProteinShoutoutsContent() {
            const shoutoutsDiv = document.getElementById('proteinShoutouts');
            if (!shoutoutsDiv) return;
            shoutoutsDiv.innerHTML = '<h4 style="color: var(--secondary-color); margin-bottom: 10px; text-align: center;">Community Protein Updates</h4>';
            
            const shoutouts = [];
            
            userList.forEach(user => {
                const proteinKey = `protein_${user}`;
                const proteinData = JSON.parse(localStorage.getItem(proteinKey) || '{}');
                
                const today = new Date();
                today.setHours(0,0,0,0);
                const todayStr = today.toDateString();

                let proteinToday = proteinData[todayStr] || 0;
                if (proteinToday === true) proteinToday = 85; 
                else if (proteinToday === false) proteinToday = 0;


                let streak = 0;
                const checkDate = new Date(today);
                for (let i = 0; i < 30; i++) {
                    const dateToCheck = new Date(checkDate);
                    dateToCheck.setDate(dateToCheck.getDate() - i);
                    if (proteinData[dateToCheck.toDateString()]) {
                        streak++;
                    } else if (i > 0) {
                        break;
                    }
                }
                
                let proteinEmoji = '';
                if (proteinToday >= 80) {
                    proteinEmoji = 'üêÇ';
                } else if (proteinToday >= 61) {
                    proteinEmoji = 'ü•©';
                } else if (proteinToday >= 31) {
                    proteinEmoji = 'üçö';
                } else {
                    proteinEmoji = 'üßÉ';
                }

                if (proteinToday >= 80) {
                    if (streak >= 4) {
                        shoutouts.push({
                            text: `${user}'s on a ${streak}-day protein streak! ${proteinEmoji}`,
                            type: 'positive'
                        });
                    } else {
                        shoutouts.push({
                            text: `${user} just hit 80g+ protein today! ${proteinEmoji}`,
                            type: 'positive'
                        });
                    }
                } else {
                    let daysSinceProtein = 0;
                    const checkDateForMiss = new Date(today);
                    let foundLast = false;
                    for (let i = 1; i < 30; i++) {
                        checkDateForMiss.setDate(checkDateForMiss.getDate() - 1);
                        if (proteinData[checkDateForMiss.toDateString()]) {
                            foundLast = true;
                            break;
                        }
                        daysSinceProtein++;
                    }
                    
                    if (!foundLast && daysSinceProtein >= 3) {
                        shoutouts.push({
                            text: `${user} hasn't logged protein in ${daysSinceProtein} days. Is he alive? üßü‚Äç‚ôÇÔ∏è`,
                            type: 'negative'
                        });
                    } else if (foundLast && daysSinceProtein > 0 && daysSinceProtein < 3) {
                         shoutouts.push({
                            text: `${user} missed protein today. Don't be a chicken. üêî`,
                            type: 'negative'
                        });
                    } else if (proteinToday < 80 && proteinToday > 0) {
                        shoutouts.push({
                            text: `${user} logged ${proteinToday}g protein today. Barely. ${proteinEmoji}`,
                            type: 'negative'
                        });
                    }
                }
            });
            
            shoutouts.forEach(shoutout => {
                const item = document.createElement('div');
                item.className = `shoutout-item shoutout-${shoutout.type}`;
                item.textContent = shoutout.text;
                shoutoutsDiv.appendChild(item);
            });
            
            if (shoutouts.length === 0) {
                const item = document.createElement('div');
                item.className = 'shoutout-item';
                item.style.color = 'var(--text-muted)';
                item.textContent = 'No protein updates yet today';
                shoutoutsDiv.appendChild(item);
            }
        }

        // Select workout day
        function selectDay(day) {
            selectedDay = day;
            
            document.querySelectorAll('.day-btn').forEach(btn => btn.classList.remove('active'));
            if (event && event.target) {
                event.target.classList.add('active'); 
            }

            showView('workoutSection');
            const workoutTitleElement = document.getElementById('workoutTitle');
            if (workoutTitleElement) {
                workoutTitleElement.textContent = `${day.toUpperCase()} DAY üî•`;
            }
            
            loadExercises(day);
        }

        // Load exercises for selected day
        function loadExercises(day) {
            const container = document.getElementById('exercisesContainer');
            if (!container) return;

            container.innerHTML = '';
            currentWorkout = [];
            
            const exercises = userExerciseTemplates[currentUser][day] || [];
            const displayExercises = exercises.filter(ex => ex.trim() !== '');

            displayExercises.forEach((exercise, index) => {
                const exerciseCard = createExerciseCard(exercise, index);
                container.appendChild(exerciseCard);
                currentWorkout.push({
                    name: exercise,
                    sets: [{ weight: '', reps: '' }]
                });
            });
        }

        // Create exercise card
        function createExerciseCard(exerciseName, index) {
            const card = document.createElement('div');
            card.className = 'exercise-card';
            
            card.innerHTML = `
                <div class="exercise-header">
                    <input type="text" class="exercise-name" value="${exerciseName}" readonly>
                    <!-- Progress Indicator will be generated here by renderProgressChart -->
                </div>
                <div class="sets-container" id="sets-${index}">
                    ${createSetRow(index, 0)}
                </div>
                <button class="add-set-btn" onclick="addSet(${index})">+ Add Set</button>
                <button class="flag-set-btn" onclick="flagSet(${index})">WTF SET üíÄ</button>
                <div class="exercise-progress-chart" id="chart-${index}">
                    <div class="chart-placeholder">Loading chart...</div>
                </div>
            `;
            
            setTimeout(() => renderProgressChart(exerciseName, index), 50); 

            return card;
        }

        // Create set row
        function createSetRow(exerciseIndex, setIndex) {
            return `
                <div class="set-row">
                    <span class="set-label">Set ${setIndex + 1}</span>
                    <input type="number" class="set-input" placeholder="Weight (kg)" 
                           onchange="updateSet(${exerciseIndex}, ${setIndex}, 'weight', this.value)">
                    <input type="number" class="set-input" placeholder="Reps" 
                           onchange="updateSet(${exerciseIndex}, ${setIndex}, 'reps', this.value)">
                    ${setIndex > 0 ? `<button class="remove-set-btn" onclick="removeSet(${exerciseIndex}, ${setIndex})">Remove</button>` : ''}
                </div>
            `;
        }

        // Add new set
        function addSet(exerciseIndex) {
            const container = document.getElementById(`sets-${exerciseIndex}`);
            if (!container) return;

            const setIndex = currentWorkout[exerciseIndex].sets.length;
            
            currentWorkout[exerciseIndex].sets.push({ weight: '', reps: '' });
            
            const newSetRow = document.createElement('div');
            newSetRow.innerHTML = createSetRow(exerciseIndex, setIndex);
            container.appendChild(newSetRow.firstElementChild);
        }

        // Remove a set
        function removeSet(exerciseIndex, setIndex) {
            currentWorkout[exerciseIndex].sets.splice(setIndex, 1);
            const container = document.getElementById(`sets-${exerciseIndex}`);
            if (!container) return;

            container.innerHTML = '';
            currentWorkout[exerciseIndex].sets.forEach((set, idx) => {
                const setRow = document.createElement('div');
                setRow.innerHTML = createSetRow(exerciseIndex, idx);
                container.appendChild(setRow.firstElementChild);
            });
            if (currentWorkout[exerciseIndex].sets.length === 0) {
                 currentWorkout[exerciseIndex].sets.push({ weight: '', reps: '' });
                 const setRow = document.createElement('div');
                 setRow.innerHTML = createSetRow(exerciseIndex, 0);
                 container.appendChild(setRow.firstElementChild);
            }
        }

        // Update set data
        function updateSet(exerciseIndex, setIndex, field, value) {
            currentWorkout[exerciseIndex].sets[setIndex][field] = value;
        }

        // Flag a set with a roast
        function flagSet(exerciseIndex) {
            const randomRoast = wtfSetRoasts[Math.floor(Math.random() * wtfSetRoasts.length)];
            showModal(`Bro what even was that set? "${randomRoast}"`, 'OK');
        }

        // Render progress chart for a specific exercise
        function renderProgressChart(exerciseName, elementIndex) {
            const chartContainer = document.getElementById(`chart-${elementIndex}`);
            if (!chartContainer) return;

            const userKey = `workouts_${currentUser}`;
            const history = JSON.parse(localStorage.getItem(userKey) || '[]');
            
            const exerciseHistory = history
                .filter(w => w.exercises.some(e => e.name === exerciseName))
                .map(w => {
                    const exerciseData = w.exercises.find(e => e.name === exerciseName);
                    const maxWeight = Math.max(...exerciseData.sets.map(s => parseFloat(s.weight) || 0));
                    return { date: new Date(w.date), weight: maxWeight };
                })
                .filter(data => data.weight > 0)
                .reverse();

            if (exerciseHistory.length < 2) {
                chartContainer.innerHTML = `<div class="chart-placeholder">Need at least 2 sessions to show progress.</div>`;
                return;
            }

            const displayHistory = exerciseHistory.slice(-10); 

            const width = chartContainer.offsetWidth;
            const height = chartContainer.offsetHeight;
            const padding = 10;

            const minWeight = Math.min(...displayHistory.map(d => d.weight));
            const maxWeight = Math.max(...displayHistory.map(d => d.weight));

            const xScale = (index) => padding + (index / (displayHistory.length - 1)) * (width - 2 * padding);
            const yScale = (weight) => {
                if (maxWeight === minWeight) return height / 2;
                return height - padding - ((weight - minWeight) / (maxWeight - minWeight)) * (height - 2 * padding);
            };

            let points = displayHistory.map((d, i) => `${xScale(i)},${yScale(d.weight)}`).join(' ');

            let trendLine = '';
            let slope = 0;
            if (displayHistory.length >= 2) {
                const sumX = displayHistory.reduce((acc, _, i) => acc + i, 0);
                const sumY = displayHistory.reduce((acc, d) => acc + d.weight, 0);
                const sumXY = displayHistory.reduce((acc, d, i) => acc + (i * d.weight), 0);
                const sumX2 = displayHistory.reduce((acc, _, i) => acc + (i * i), 0);
                const n = displayHistory.length;

                const denominator = (n * sumX2 - sumX * sumX);
                if (denominator !== 0) {
                    slope = (n * sumXY - sumX * sumY) / denominator;
                    const intercept = (sumY - slope * sumX) / n;

                    const startY = yScale(intercept);
                    const endY = yScale(slope * (n - 1) + intercept);

                    trendLine = `M${xScale(0)},${startY} L${xScale(n - 1)},${endY}`;
                }
            }

            const header = chartContainer.previousElementSibling;
            let progressIndicator = header.querySelector('.progress-indicator');
            if (!progressIndicator) {
                progressIndicator = document.createElement('div');
                progressIndicator.className = 'progress-indicator';
                header.appendChild(progressIndicator);
            }

            let trendColorClass = 'regression-stable';
            if (slope > 0.1) {
                progressIndicator.innerHTML = `<span style="color: var(--secondary-color); font-size: 1.5rem;">‚Üë</span> <span style="color: var(--secondary-color); font-size: 0.9rem;">Upward Trend</span>`;
                trendColorClass = 'regression-up';
            } else if (slope < -0.1) {
                progressIndicator.innerHTML = `<span style="color: var(--danger-color); font-size: 1.5rem;">‚Üì</span> <span style="color: var(--danger-color); font-size: 0.9rem;">Downward Trend</span>`;
                trendColorClass = 'regression-down';
            } else {
                progressIndicator.innerHTML = `<span style="color: var(--text-muted); font-size: 1.5rem;">‚Üí</span> <span style="color: var(--text-muted); font-size: 0.9rem;">Stable</span>`;
            }


            chartContainer.innerHTML = `
                <svg width="${width}" height="${height}">
                    <polyline points="${points}" stroke="var(--primary-color)" fill="none" stroke-width="2"/>
                    ${displayHistory.map((d, i) => `<circle cx="${xScale(i)}" cy="${yScale(d.weight)}" r="3" fill="var(--primary-color)"/>`).join('')}
                    <path d="${trendLine}" class="chart-line ${trendColorClass}" />
                </svg>
            `;
        }


        // Save workout
        function saveWorkout() {
            if (!selectedDay || currentWorkout.length === 0) {
                showModal('Please select a day and enter at least one exercise with weight and reps.', 'OK');
                return;
            }
            
            const filteredWorkout = currentWorkout.filter(ex => 
                ex.name.trim() !== '' && ex.sets.some(set => parseFloat(set.weight) > 0 && parseFloat(set.reps) > 0)
            );

            if (filteredWorkout.length === 0) {
                showModal('Please enter valid weight and reps for at least one exercise to save the workout.', 'OK');
                return;
            }

            const workoutData = {
                date: new Date().toISOString(),
                day: selectedDay,
                exercises: filteredWorkout
            };
            
            const workoutProteinCheck = document.getElementById('workoutProteinCheck');
            const proteinChecked = workoutProteinCheck ? workoutProteinCheck.checked : false;
            if (proteinChecked) {
                const today = new Date().toDateString();
                const proteinKey = `protein_${currentUser}`;
                const proteinData = JSON.parse(localStorage.getItem(proteinKey) || '{}');
                proteinData[today] = true; // Assuming true means 80g+
                localStorage.setItem(proteinKey, JSON.stringify(proteinData));
            }
            
            const userKey = `workouts_${currentUser}`;
            const history = JSON.parse(localStorage.getItem(userKey) || '[]');
            history.unshift(workoutData);
            
            if (history.length > 100) history.pop();
            
            localStorage.setItem(userKey, JSON.stringify(history));
            
            showModal('Workout saved! üí™', 'OK', () => {
                spawnConfetti(); // Confetti on successful save
                showView('daySelection');
                loadStats();
                loadLeaderboards();
                loadDailyHighlights();
                loadProteinData();
                loadCommunity();
                loadMyProfile();
            });
        }

        // Load stats for current user (for the top stats bar)
        function loadStats() {
            const userKey = `workouts_${currentUser}`;
            const history = JSON.parse(localStorage.getItem(userKey) || '[]');
            
            const startDate = new Date('2024-08-10'); 
            
            const counts = { chest: 0, back: 0, arms: 0, legs: 0, push: 0, pull: 0 };
            let totalWorkoutsSinceStart = 0;

            history.forEach(w => {
                if (new Date(w.date) >= startDate) {
                    if (counts[w.day] !== undefined) {
                        counts[w.day]++;
                        totalWorkoutsSinceStart++;
                    }
                }
            });
            
            const streak = calculateWorkoutStreak(history); 
            
            const streakCountElement = document.getElementById('streakCount');
            if (streakCountElement) {
                streakCountElement.textContent = streak;
            }
            const totalDaysElement = document.getElementById('totalDays');
            if (totalDaysElement) {
                totalDaysElement.textContent = totalWorkoutsSinceStart;
            }
        }

        // Calculate workout streak (renamed to avoid conflict with protein streak)
        function calculateWorkoutStreak(history) {
            if (history.length === 0) return 0;
            
            let streak = 0;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            let currentDate = new Date(today);
            let restDays = 0;
            
            while (true) {
                const dateStr = currentDate.toDateString();
                const hasWorkout = history.some(w => 
                    new Date(w.date).toDateString() === dateStr
                );
                
                if (hasWorkout) {
                    streak++;
                    restDays = 0;
                } else {
                    restDays++;
                }

                if (restDays > 1 && streak > 0) {
                    break;
                }
                if (currentDate.toDateString() === today.toDateString() && !hasWorkout && streak === 0) {
                } else if (currentDate.toDateString() !== today.toDateString() && restDays > 1) {
                    break;
                }
                 if (streak > 0 && restDays > 1) break;
                 if (streak === 0 && restDays > 0 && currentDate.toDateString() !== today.toDateString()) break;

                currentDate.setDate(currentDate.getDate() - 1);
                if ((today - currentDate) / (1000 * 60 * 60 * 24) > 365) break; 
            }
            
            return streak;
        }


        // Load daily highlights
        function loadDailyHighlights() {
            const container = document.getElementById('dailyHighlightsContainer');
            if (!container) return;
            container.innerHTML = '';
            
            const today = new Date();
            today.setHours(0,0,0,0);
            const todayStr = today.toDateString();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toDateString();
            
            let todayWorkouts = [];
            let yesterdayWorkouts = [];
            
            userList.forEach(user => {
                const userKey = `workouts_${user}`;
                const history = JSON.parse(localStorage.getItem(userKey) || '[]');
                
                const workoutToday = history.find(w => new Date(w.date).toDateString() === todayStr);
                const workoutYesterday = history.find(w => new Date(w.date).toDateString() === yesterdayStr);
                
                if (workoutToday) {
                    todayWorkouts.push({ user, workout: workoutToday.day });
                }
                if (workoutYesterday) {
                    yesterdayWorkouts.push({ user, workout: yesterdayWorkout.day });
                }
            });
            
            // Show today's workouts
            if (todayWorkouts.length > 0) {
                const todayDiv = document.createElement('div');
                todayDiv.innerHTML = '<h3 style="color: var(--primary-color); margin-bottom: 10px; text-align: center;">Today\'s Champions üèÜ</h3>';
                
                todayWorkouts.forEach(({ user, workout }) => {
                    const card = document.createElement('div');
                    card.className = 'highlight-card leaderboard-item';
                    card.innerHTML = `
                        <span class="leaderboard-name">${user}</span>
                        <span class="leaderboard-value" style="color: var(--secondary-color);">${workout.toUpperCase()} DAY ‚úÖ</span>
                    `;
                    todayDiv.appendChild(card);
                });
                
                container.appendChild(todayDiv);
            }

            // Roast those who didn't work out today
            const skippers = userList.filter(u => !todayWorkouts.find(w => w.user === u));
            if (skippers.length > 0 && todayWorkouts.length > 0) {
                const roastDiv = document.createElement('div');
                roastDiv.innerHTML = '<h3 style="color: var(--danger-color); margin-top: 20px; margin-bottom: 10px; text-align: center;">The Slackers Hall of Shame üò§</h3>';
                skippers.forEach(skipper => {
                    const roast = roastMessages[Math.floor(Math.random() * roastMessages.length)];
                    const card = document.createElement('div');
                    card.className = 'highlight-card leaderboard-item';
                    card.innerHTML = `
                        <span class="leaderboard-name">${skipper}</span>
                        <span class="roast-message">${roast}</span>
                    `;
                    roastDiv.appendChild(card);
                });
                container.appendChild(roastDiv);
            }
            
            // Show yesterday's workouts
            if (yesterdayWorkouts.length > 0) {
                const yesterdayDiv = document.createElement('div');
                yesterdayDiv.innerHTML = '<h3 style="color: var(--text-muted); margin-top: 20px; margin-bottom: 10px; text-align: center;">Yesterday\'s Warriors</h3>';
                
                yesterdayWorkouts.forEach(({ user, workout }) => {
                    const card = document.createElement('div');
                    card.className = 'highlight-card leaderboard-item';
                    card.innerHTML = `
                        <span class="leaderboard-name">${user}</span>
                        <span class="leaderboard-value" style="color: var(--text-muted);">${workout.toUpperCase()} DAY</span>
                    `;
                    yesterdayDiv.appendChild(card);
                });
                
                container.appendChild(yesterdayDiv);
            }

            if (todayWorkouts.length === 0 && yesterdayWorkouts.length === 0 && skippers.length === userList.length) {
                 container.innerHTML = '<p style="color: var(--text-muted); text-align: center;">No workout activity recently.</p>';
            }
        }


        // Load leaderboards
        function loadLeaderboards() {
            const userMetrics = userList.map(user => {
                const userKey = `workouts_${user}`;
                const history = JSON.parse(localStorage.getItem(userKey) || '[]');
                const proteinData = JSON.parse(localStorage.getItem(`protein_${user}`) || '{}');
                
                const workoutStreak = calculateWorkoutStreak(history);
                
                const startDate = new Date('2024-08-10');
                const totalWorkoutsSinceStart = history.filter(w => new Date(w.date) >= startDate).length;
                
                const streakBreaks = calculateStreakBreaks(history);
                const missedLegDays = calculateMissedLegDays(user, history);
                
                const lastWorkout = history.length > 0 ? new Date(history[0].date) : null;
                const daysSinceLastWorkout = lastWorkout ? 
                    Math.floor((new Date() - lastWorkout) / (1000 * 60 * 60 * 24)) : 999;
                const isGhost = daysSinceLastWorkout > 5;

                let proteinStreak = 0;
                const today = new Date();
                for (let i = 0; i < 30; i++) {
                    const checkDate = new Date(today);
                    checkDate.setDate(checkDate.getDate() - i);
                    if (proteinData[checkDate.toDateString()]) {
                        proteinStreak++;
                    } else if (i > 0) {
                        break;
                    }
                }
                let totalProteinDays = Object.values(proteinData).filter(v => v).length;
                let last7DaysProtein = 0;
                for (let i = 0; i < 7; i++) {
                    const checkDate = new Date();
                    checkDate.setDate(checkDate.getDate() - i);
                    if (proteinData[checkDate.toDateString()]) {
                        last7DaysProtein++;
                    }
                }
                
                return {
                    user,
                    workoutStreak,
                    totalWorkoutsSinceStart,
                    streakBreaks,
                    missedLegDays,
                    isGhost,
                    daysSinceLastWorkout,
                    proteinStreak,
                    totalProteinDays,
                    last7DaysProtein,
                    chestDays: history.filter(w => w.day === 'chest' || w.day === 'push').length,
                    backDays: history.filter(w => w.day === 'back' || w.day === 'pull').length,
                    armsDays: history.filter(w => w.day === 'arms').length,
                    legDays: history.filter(w => w.day === 'legs').length,
                };
            });
            
            const currentUserMetrics = userMetrics.find(m => m.user === currentUser);
            if (currentUserMetrics) {
                const personalStreakCount = document.getElementById('personalStreakCount');
                if (personalStreakCount) personalStreakCount.textContent = currentUserMetrics.workoutStreak;
                const personalTotalWorkouts = document.getElementById('personalTotalWorkouts');
                if (personalTotalWorkouts) personalTotalWorkouts.textContent = currentUserMetrics.totalWorkoutsSinceStart;
                const personalChestDays = document.getElementById('personalChestDays');
                if (personalChestDays) personalChestDays.textContent = currentUserMetrics.chestDays;
                const personalBackDays = document.getElementById('personalBackDays');
                if (personalBackDays) personalBackDays.textContent = currentUserMetrics.backDays;
                const personalArmDays = document.getElementById('personalArmDays');
                if (personalArmDays) personalArmDays.textContent = currentUserMetrics.armsDays;
                const personalLegDays = document.getElementById('personalLegDays');
                if (personalLegDays) personalLegDays.textContent = currentUserMetrics.legDays;
                const personalProteinStreak = document.getElementById('personalProteinStreak');
                if (personalProteinStreak) personalProteinStreak.textContent = currentUserMetrics.proteinStreak;
                const personalTotalProteinDays = document.getElementById('personalTotalProteinDays');
                if (personalTotalProteinDays) personalTotalProteinDays.textContent = currentUserMetrics.totalProteinDays;
                const personalLast7DaysProtein = document.getElementById('personalLast7DaysProtein');
                if (personalLast7DaysProtein) personalLast7DaysProtein.textContent = `${currentUserMetrics.last7DaysProtein}/7`;
            }

            updateLeaderboardDisplay('streakLeaderboard', userMetrics, 'workoutStreak', ' üî•', false, true, 3);
            updateLeaderboardDisplay('consistencyLeaderboard', userMetrics, 'totalWorkoutsSinceStart', ' days', false, true, 3);
            updateLeaderboardDisplay('excusersLeaderboard', userMetrics, 'streakBreaks', 'x üò§', false, false, 3);
            updateLeaderboardDisplay('chickenLegsLeaderboard', userMetrics, 'missedLegDays', 'x üêî', false, false, 3);

            updateLeaderboardDisplay('fullStreakLeaderboard', userMetrics, 'workoutStreak', ' üî•', false, true, userList.length);
            updateLeaderboardDisplay('fullConsistencyLeaderboard', userMetrics, 'totalWorkoutsSinceStart', ' days', false, true, userList.length);
            updateLeaderboardDisplay('fullExcusersLeaderboard', userMetrics, 'streakBreaks', 'x üò§', false, false, userList.length);
            updateLeaderboardDisplay('fullChickenLegsLeaderboard', userMetrics, 'missedLegDays', 'x üêî', false, false, userList.length);
        }

        // Helper to update leaderboard display
        function updateLeaderboardDisplay(containerId, metrics, valueKey, suffix = '', ascending = false, rankIcons = true, showLimit = 3) {
            const container = document.getElementById(containerId);
            if (!container) return;

            const sorted = [...metrics].sort((a, b) => {
                if (ascending) return a[valueKey] - b[valueKey];
                return b[valueKey] - a[valueKey];
            });
            
            container.innerHTML = '';

            const displayCount = Math.min(showLimit, sorted.length);

            for (let i = 0; i < displayCount; i++) {
                const user = sorted[i];
                const item = document.createElement('div');
                item.className = 'leaderboard-item';

                let rankMarkup = `<span>${i + 1}</span>`;
                if (rankIcons && i === 0) rankMarkup = 'ü•á';
                else if (rankIcons && i === 1) rankMarkup = 'ü•à';
                else if (rankIcons && i === 2) rankMarkup = 'ü•â';

                if (i === 0) item.classList.add('top-1');
                else if (i === 1) item.classList.add('top-2');
                else if (i === 2) item.classList.add('top-3');
                
                const ghostBadge = user.isGhost ? '<span class="ghost-badge">üëª Ghost Mode</span>' : '';
                
                item.innerHTML = `
                    <span class="leaderboard-rank">${rankMarkup}</span>
                    <span class="leaderboard-name">${user.user} ${ghostBadge}</span>
                    <span class="leaderboard-value">${user[valueKey]}${suffix}</span>
                `;
                
                container.appendChild(item);
            }
        }

        // Calculate streak breaks (days with no workout between two workout days)
        function calculateStreakBreaks(history) {
            if (history.length < 2) return 0;
            
            let breaks = 0;
            const sortedHistory = [...history].sort((a, b) => new Date(a.date) - new Date(b.date));
            
            for (let i = 1; i < sortedHistory.length; i++) {
                const prevDate = new Date(sortedHistory[i - 1].date);
                const currDate = new Date(sortedHistory[i].date);
                const daysDiff = Math.floor((currDate - prevDate) / (1000 * 60 * 60 * 24));
                
                if (daysDiff > 2) {
                    breaks++;
                }
            }
            
            return breaks;
        }

        // Calculate missed leg days
        function calculateMissedLegDays(user, userHistory) {
            let missedCount = 0;
            const legDaysGlobal = new Set(); 
            
            userList.forEach(u => {
                const history = JSON.parse(localStorage.getItem(`workouts_${u}`) || '[]');
                history.forEach(workout => {
                    if (workout.day === 'legs') {
                        legDaysGlobal.add(workout.date.split('T')[0]);
                    }
                });
            });
            
            legDaysGlobal.forEach(date => {
                const didLegs = userHistory.some(w => 
                    w.date.split('T')[0] === date && w.day === 'legs'
                );
                if (!didLegs) {
                    missedCount++;
                }
            });
            
            return missedCount;
        }

        // Update load community to use saved user list
        function loadCommunity() {
            const container = document.getElementById('communityContainer');
            if (!container) return;
            container.innerHTML = '';
            
            userList.forEach(user => {
                const userKey = `workouts_${user}`;
                const history = JSON.parse(localStorage.getItem(userKey) || '[]');
                
                const startDate = new Date('2024-08-10');
                const workoutsSinceAug = history.filter(w => new Date(w.date) >= startDate);
                
                const counts = { chest: 0, back: 0, arms: 0, legs: 0, push: 0, pull: 0 };
                workoutsSinceAug.forEach(w => {
                    if (counts[w.day] !== undefined) counts[w.day]++;
                });
                
                const totalWorkouts = Object.values(counts).reduce((a, b) => a + b, 0);
                const streak = calculateWorkoutStreak(history);
                
                const summaryDiv = document.createElement('div');
                summaryDiv.className = 'user-summary';
                summaryDiv.setAttribute('onclick', `showUserProfile('${user}')`);
                summaryDiv.innerHTML = `
                    <div class="user-summary-header">
                        <span class="user-summary-name">${user}</span>
                        <span class="user-streak">üî• ${streak} day streak</span>
                    </div>
                    <div class="workout-breakdown">
                        <div class="breakdown-item">
                            <div class="breakdown-number">${totalWorkouts}</div>
                            <div class="breakdown-label">Total</div>
                        </div>
                        <div class="breakdown-item">
                            <div class="breakdown-number">${counts.chest + counts.push}</div>
                            <div class="breakdown-label">Chest</div>
                        </div>
                        <div class="breakdown-item">
                            <div class="breakdown-number">${counts.back + counts.pull}</div>
                            <div class="breakdown-label">Back</div>
                        </div>
                        <div class="breakdown-item">
                            <div class="breakdown-number">${counts.arms}</div>
                            <div class="breakdown-label">Arms</div>
                        </div>
                        <div class="breakdown-item">
                            <div class="breakdown-number">${counts.legs}</div>
                            <div class="breakdown-label">Legs</div>
                        </div>
                    </div>
                `;
                
                container.appendChild(summaryDiv);
            });
        }

        // Show a specific user's profile and workout history
        function showUserProfile(username) {
            showView('userProfileView');
            const profileTitleElement = document.getElementById('userProfileView').querySelector('.profile-title');
            if (profileTitleElement) {
                profileTitleElement.textContent = `${username}'s Progress`;
            }
            
            const userMetrics = userList.map(user => {
                const userHistory = JSON.parse(localStorage.getItem(`workouts_${user}`) || '[]');
                const proteinData = JSON.parse(localStorage.getItem(`protein_${user}`) || '{}');
                const startDate = new Date('2024-08-10');
                const totalWorkoutsSinceStart = userHistory.filter(w => new Date(w.date) >= startDate).length;
                const workoutStreak = calculateWorkoutStreak(userHistory);
                const proteinStreak = calculateProteinStreak(proteinData);
                const totalProteinDays = Object.values(proteinData).filter(v => v).length;

                return {
                    user,
                    totalWorkoutsSinceStart,
                    workoutStreak,
                    proteinStreak,
                    totalProteinDays,
                    chestDays: userHistory.filter(w => w.day === 'chest' || w.day === 'push').length,
                    backDays: userHistory.filter(w => w.day === 'back' || w.day === 'pull').length,
                    armsDays: userHistory.filter(w => w.day === 'arms').length,
                    legDays: userHistory.filter(w => w.day === 'legs').length,
                };
            }).sort((a, b) => b.totalWorkoutsSinceStart - a.totalWorkoutsSinceStart);

            const otherUserStats = userMetrics.find(m => m.user === username);
            const otherRank = userMetrics.findIndex(m => m.user === username) + 1;

            if (otherUserStats) {
                document.getElementById('otherProfileName').textContent = username;
                document.getElementById('otherProfileRank').textContent = `Rank: ${otherRank}`;
                document.getElementById('otherProfileCurrentStreak').textContent = otherUserStats.workoutStreak;
                document.getElementById('otherProfileTotalWorkouts').textContent = otherUserStats.totalWorkoutsSinceStart;
                document.getElementById('otherProfileChestDays').textContent = otherUserStats.chestDays;
                document.getElementById('otherProfileBackDays').textContent = otherUserStats.backDays;
                document.getElementById('otherProfileArmDays').textContent = otherUserStats.armsDays;
                document.getElementById('otherProfileLegDays').textContent = otherUserStats.legDays;
            }

            const otherUserHistory = JSON.parse(localStorage.getItem(`workouts_${username}`) || '[]');
            renderWorkoutDistributionChart(otherUserHistory, 'otherWorkoutDistributionChart', 'otherWorkoutDistributionLegend');
            renderWorkoutHeatmap(otherUserHistory, 'otherWorkoutHeatmap');


            const otherUserProfileWorkoutsDiv = document.getElementById('otherUserProfileWorkouts');
            if (!otherUserProfileWorkoutsDiv) return;

            otherUserProfileWorkoutsDiv.innerHTML = '';

            if (otherUserHistory.length === 0) {
                otherUserProfileWorkoutsDiv.innerHTML = '<p style="color: var(--text-muted); text-align: center;">No workouts recorded for this user.</p>';
                return;
            }

            const workoutsByDate = {};
            otherUserHistory.forEach(workout => {
                const date = new Date(workout.date).toLocaleDateString();
                if (!workoutsByDate[date]) {
                    workoutsByDate[date] = [];
                }
                workoutsByDate[date].push(workout);
            });

            Object.keys(workoutsByDate).sort((a, b) => new Date(b) - new Date(a)).forEach(date => {
                const dateHeader = document.createElement('h3');
                dateHeader.style.color = 'var(--text-light)';
                dateHeader.style.marginTop = '20px';
                dateHeader.style.marginBottom = '10px';
                dateHeader.textContent = date;
                otherUserProfileWorkoutsDiv.appendChild(dateHeader);

                workoutsByDate[date].forEach(workout => {
                    const workoutDiv = document.createElement('div');
                    workoutDiv.className = 'previous-workout';
                    
                    let exercisesHtml = '';
                    workout.exercises.forEach(ex => {
                        const setsStr = ex.sets
                            .filter(s => s.weight && s.reps)
                            .map(s => `${s.weight}kg x ${s.reps}`)
                            .join(', ');
                        
                        exercisesHtml += `
                            <div class="previous-exercise">
                                <div class="previous-exercise-name">${ex.name}</div>
                                <div class="previous-sets">${setsStr}</div>
                            </div>
                        `;
                    });
                    
                    workoutDiv.innerHTML = `
                        <div style="color: var(--primary-color); font-weight: 600; margin-bottom: 10px;">${workout.day.toUpperCase()} DAY</div>
                        ${exercisesHtml}
                    `;
                    otherUserProfileWorkoutsDiv.appendChild(workoutDiv);
                });
            });
        }

        // New function to load My Profile data
        function loadMyProfile() {
            const userKey = `workouts_${currentUser}`;
            const history = JSON.parse(localStorage.getItem(userKey) || '[]');

            const proteinKey = `protein_${currentUser}`;
            const proteinData = JSON.parse(localStorage.getItem(proteinKey) || '{}');

            // Get user's rank
            const allUserMetrics = userList.map(user => {
                const userHistory = JSON.parse(localStorage.getItem(`workouts_${user}`) || '[]');
                const startDate = new Date('2024-08-10');
                const totalWorkoutsSinceStart = userHistory.filter(w => new Date(w.date) >= startDate).length;
                return { user, totalWorkoutsSinceStart };
            }).sort((a, b) => b.totalWorkoutsSinceStart - a.totalWorkoutsSinceStart);

            const myRank = allUserMetrics.findIndex(m => m.user === currentUser) + 1;

            // Update profile header
            document.getElementById('myProfileName').textContent = currentUser;
            document.getElementById('myProfileRank').textContent = `Rank: ${myRank}`;

            // Update profile stats grid
            const myWorkoutStreak = calculateWorkoutStreak(history);
            const myTotalWorkouts = history.filter(w => new Date(w.date) >= new Date('2024-08-10')).length;
            const myChestDays = history.filter(w => w.day === 'chest' || w.day === 'push').length;
            const myBackDays = history.filter(w => w.day === 'back' || w.day === 'pull').length;
            const myArmDays = history.filter(w => w.day === 'arms').length;
            const myLegDays = history.filter(w => w.day === 'legs').length;
            const myProteinStreak = calculateProteinStreak(proteinData);
            const myTotalProteinDays = Object.values(proteinData).filter(v => v).length;

            document.getElementById('myProfileCurrentStreak').textContent = myWorkoutStreak;
            document.getElementById('myProfileTotalWorkouts').textContent = myTotalWorkouts;
            document.getElementById('myProfileChestDays').textContent = myChestDays;
            document.getElementById('myProfileBackDays').textContent = myBackDays;
            document.getElementById('myProfileArmDays').textContent = myArmDays;
            document.getElementById('myProfileLegDays').textContent = myLegDays;
            // Protein stats are already updated by updateProteinStats, but ensure they are displayed here.
            // document.getElementById('myProfileProteinStreak').textContent = myProteinStreak; // These are already updated by updateProteinStats
            // document.getElementById('myProfileTotalProteinDays').textContent = myTotalProteinDays; // These are already updated by updateProteinStats


            // Render Workout Distribution Pie Chart
            renderWorkoutDistributionChart(history, 'workoutDistributionChart', 'workoutDistributionLegend');

            // Render Workout Heatmap
            renderWorkoutHeatmap(history, 'workoutHeatmap');

            // Update glowing border for My Profile header button
            const myProfileHeaderBtn = document.querySelector('.my-profile-header-btn');
            if (myProfileHeaderBtn) {
                if (myWorkoutStreak > 3) {
                    myProfileHeaderBtn.classList.add('glowing-border');
                } else {
                    myProfileHeaderBtn.classList.remove('glowing-border');
                }
            }
        }

        // Helper function to calculate protein streak (similar to workout streak)
        function calculateProteinStreak(proteinData) {
            if (Object.keys(proteinData).length === 0) return 0;
            
            let streak = 0;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            let currentDate = new Date(today);
            
            for (let i = 0; i < 30; i++) {
                const dateStr = currentDate.toDateString();
                if (proteinData[dateStr]) {
                    streak++;
                } else {
                    break;
                }
                currentDate.setDate(currentDate.getDate() - 1);
            }
            return streak;
        }

        // Renders the workout distribution pie chart
        function renderWorkoutDistributionChart(history, chartId, legendId) {
            const chartContainer = document.getElementById(chartId);
            const legendContainer = document.getElementById(legendId);
            if (!chartContainer || !legendContainer) return;

            const counts = { chest: 0, back: 0, arms: 0, legs: 0, push: 0, pull: 0 };
            history.forEach(w => {
                if (counts[w.day] !== undefined) {
                    counts[w.day]++;
                }
            });

            const data = [
                { label: 'Chest', value: counts.chest + counts.push, color: '#FF6384' },
                { label: 'Back', value: counts.back + counts.pull, color: '#36A2EB' },
                { label: 'Arms', value: counts.arms, color: '#FFCE56' },
                { label: 'Legs', value: counts.legs, color: '#4BC0C0' }
            ].filter(d => d.value > 0);

            if (data.length === 0) {
                chartContainer.innerHTML = '<div class="chart-placeholder-large">No workout data for distribution.</div>';
                legendContainer.innerHTML = '';
                return;
            }

            const total = data.reduce((sum, d) => sum + d.value, 0);
            const radius = 80;
            const centerX = 100;
            const centerY = 100;

            let startAngle = 0;
            let svgPaths = '';
            let legendHtml = '';

            data.forEach(slice => {
                const angle = (slice.value / total) * 2 * Math.PI;
                const endAngle = startAngle + angle;

                const x1 = centerX + radius * Math.cos(startAngle);
                const y1 = centerY + radius * Math.sin(startAngle);
                const x2 = centerX + radius * Math.cos(endAngle);
                const y2 = centerY + radius * Math.sin(endAngle);

                const largeArcFlag = angle > Math.PI ? 1 : 0;

                svgPaths += `
                    <path d="M${centerX},${centerY} L${x1},${y1} A${radius},${radius} 0 ${largeArcFlag} 1 ${x2},${y2} Z" fill="${slice.color}">
                        <title>${slice.label}: ${slice.value} workouts (${((slice.value / total) * 100).toFixed(1)}%)</title>
                    </path>
                `;
                legendHtml += `
                    <div class="legend-item">
                        <span class="legend-color" style="background-color: ${slice.color};"></span>
                        <span>${slice.label} (${((slice.value / total) * 100).toFixed(0)}%)</span>
                    </div>
                `;
                startAngle = endAngle;
            });

            chartContainer.innerHTML = `<svg class="pie-chart-svg" width="200" height="200" viewBox="0 0 200 200">${svgPaths}</svg>`;
            legendContainer.innerHTML = legendHtml;
        }

        // Renders the workout heatmap
        function renderWorkoutHeatmap(history, heatmapId) {
            const heatmapContainer = document.getElementById(heatmapId);
            if (!heatmapContainer) return;
            heatmapContainer.innerHTML = '';

            const today = new Date();
            today.setHours(0,0,0,0);
            const oneYearAgo = new Date(today);
            oneYearAgo.setFullYear(today.getFullYear() - 1);

            const workoutDates = {}; // Store count of workouts per day
            history.forEach(w => {
                const dateStr = new Date(w.date).toDateString();
                workoutDates[dateStr] = (workoutDates[dateStr] || 0) + 1;
            });

            let currentDate = new Date(oneYearAgo);
            let monthCounter = -1;

            while (currentDate <= today) {
                const dayOfWeek = currentDate.getDay();

                if (currentDate.toDateString() === oneYearAgo.toDateString()) {
                    for (let i = 0; i < dayOfWeek; i++) {
                        const emptySquare = document.createElement('div');
                        emptySquare.className = 'day-square';
                        heatmapContainer.appendChild(emptySquare);
                    }
                }

                if (currentDate.getDate() === 1 || (monthCounter === -1 && dayOfWeek === 0)) {
                    if (monthCounter !== currentDate.getMonth()) {
                        monthCounter = currentDate.getMonth();
                        const monthLabel = document.createElement('div');
                        monthLabel.className = 'month-label';
                        monthLabel.textContent = currentDate.toLocaleString('default', { month: 'short' });
                        heatmapContainer.appendChild(monthLabel);
                    }
                }

                const square = document.createElement('div');
                square.className = 'day-square';
                
                const workoutsToday = workoutDates[currentDate.toDateString()] || 0;
                if (workoutsToday > 0) {
                    if (workoutsToday >= 3) {
                        square.classList.add('active-3'); // Darkest green for 3+ workouts
                    } else if (workoutsToday === 2) {
                        square.classList.add('active-2'); // Medium green for 2 workouts
                    } else {
                        square.classList.add('active-1'); // Light green for 1 workout
                    }
                } else {
                    // Check if it's a skipped day (more than 1 rest day before current date)
                    const tempDate = new Date(currentDate);
                    tempDate.setDate(tempDate.getDate() - 1); // Check yesterday
                    const yesterdayHasWorkout = workoutDates[tempDate.toDateString()];
                    tempDate.setDate(tempDate.getDate() - 1); // Check day before yesterday
                    const dayBeforeYesterdayHasWorkout = workoutDates[tempDate.toDateString()];

                    if (!yesterdayHasWorkout && !dayBeforeYesterdayHasWorkout && currentDate.toDateString() !== today.toDateString()) {
                        square.classList.add('skipped-roast'); // Blood red
                        square.title = `Skipped on ${currentDate.toLocaleDateString()}`; // Tooltip for skipped days
                    } else {
                        square.classList.add('active-0'); // Default inactive
                    }
                }

                heatmapContainer.appendChild(square);
                currentDate.setDate(currentDate.getDate() + 1);
            }
        }

        // Savage Tools Functions
        function triggerPRSelfie() {
            showModal("Flex now or it didn‚Äôt happen. üì∏\n(Imagine a camera flash and flexing sound)", "OK, I'll flex!");
        }

        function roastMyWeakness() {
            const bodyParts = ['chest', 'back', 'arms', 'legs', 'shoulders', 'abs'];
            const randomBodyPart = bodyParts[Math.floor(Math.random() * bodyParts.length)];
            const roast = `Your ${randomBodyPart} is smaller than your ego. Get to work!`;
            showModal(roast, "Ouch, OK!");
        }

        function generateExcuse() {
            const randomExcuse = excuses[Math.floor(Math.random() * excuses.length)];
            showModal(`Why didn‚Äôt you gym today? \n"${randomExcuse}"`, "Perfect excuse!");
        }

        function generateFakeStat() {
            const randomFakeStat = fakeStats[Math.floor(Math.random() * fakeStats.length)];
            showModal(`${randomFakeStat} \n\nBro, that's cap. üß¢`, "I know, right?");
        }

        function dailyDare() {
            const usersForDare = userList.filter(u => u !== currentUser);
            if (usersForDare.length === 0) {
                showModal("No one else to dare, you're the only savage left!", "Lonely gains...");
                return;
            }
            const randomUser = usersForDare[Math.floor(Math.random() * usersForDare.length)];
            const dares = [
                `Hey ${randomUser}, try legs today. We dare you.`,
                `${randomUser}, can you even do 5 push-ups? Prove it.`,
                `Dare ${randomUser} to hit a new PR on their weakest lift.`,
                `${randomUser}, don't skip protein today. We're watching.`,
                `${randomUser}, do 50 burpees right now. No excuses.`
            ];
            const randomDare = dares[Math.floor(Math.random() * dares.length)];
            showModal(randomDare, "Dare Accepted (maybe)");
        }

        function showBroCode() {
            const codeHtml = broCode.map((rule, index) => `${index + 1}. ${rule}`).join('<br><br>');
            showModal(`<h3>The Bro Code:</h3><br>${codeHtml}`, "Understood, Bro.");
        }


        // Confetti animation
        function spawnConfetti() {
            const confettiContainer = document.createElement('div');
            confettiContainer.className = 'confetti-container';
            document.body.appendChild(confettiContainer);

            for (let i = 0; i < 50; i++) {
                const dot = document.createElement('div');
                dot.className = 'confetti-dot';
                dot.style.left = `${Math.random() * 100}vw`;
                dot.style.top = `${Math.random() * 100}vh`;
                dot.style.animationDelay = `${Math.random() * 0.5}s`;
                dot.style.animationDuration = `${2.5 + Math.random() * 1}s`;
                confettiContainer.appendChild(dot);
            }

            setTimeout(() => {
                document.body.removeChild(confettiContainer);
            }, 3000); // Remove container after animation
        }


        // Logout function
        function logout() {
            localStorage.removeItem('currentUser');
            location.reload();
        }

        // Initialize on load
        init();
    </script>
</body>
</html>
ÔøΩ
